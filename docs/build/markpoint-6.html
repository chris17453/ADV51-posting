<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Markpoint 6: Post Fuel Charges &mdash; TAS Posting  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Markpoint 7: Update Inventory Location" href="markpoint-7.html" />
    <link rel="prev" title="Markpoint 5: Post Freight Charges" href="markpoint-5.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            TAS Posting
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="post_so.html">Post_SO</a></li>
<li class="toctree-l1"><a class="reference internal" href="pre-valiation.html">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-1.html">Mark Point 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-3.html">Mark Point 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-4.html">Mark Point 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-5.html">Mark Point 5</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Mark Point 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-7.html">Mark Point 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-8.html">Mark Point 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-9.html">Mark Point 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-10.html">Mark Point 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-11.html">Mark Point 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-12.html">Mark Point 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-13.html">Mark Point 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-14.html">Mark Point 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-15.html">Mark Point 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-16.html">Mark Point 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-17.html">Mark Point 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-18.html">Mark Point 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-19.html">Mark Point 19</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-20.html">Mark Point 20</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-23.html">Mark Point 23</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-24.html">Mark Point 24</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-25.html">Mark Point 25</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-26.html">Mark Point 26</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="post_to_gl2.html">POST_TO_GL2 post_to_gl2</a></li>
<li class="toctree-l1"><a class="reference internal" href="all_tables.html">All Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint.html">Markpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="errorlog.html">ErrorLog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">TAS Posting</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Markpoint 6: Post Fuel Charges</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/markpoint-6.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="markpoint-6-post-fuel-charges">
<h1>Markpoint 6: Post Fuel Charges<a class="headerlink" href="#markpoint-6-post-fuel-charges" title="Link to this heading"></a></h1>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading"></a></h2>
<p>This function posts fuel charges to the general ledger if the fuel amount is not zero. The general ledger account is selected based on the customer class. If the customer class is <code class="docutils literal notranslate"><span class="pre">GP</span></code>, a specific GL account is used; otherwise, a different GL account is assigned. The department code for fuel is based on the invoice location.</p>
</section>
<section id="sql-function">
<h2>SQL Function<a class="headerlink" href="#sql-function" title="Link to this heading"></a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">markpoint_6_PostFuelToGL</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">@</span><span class="n">invoiceNum</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">fuel_glacct</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">invFuel</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">invLoc</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">cusClass</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">post_nolock</span><span class="w"> </span><span class="nb">BIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">-- Get invoice details</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">invFuel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_FUEL</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">invLoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">LEFT</span><span class="p">(</span><span class="n">BKAR_INV_LOC</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARINV</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKAR_INV_NUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- If fuel is zero, exit function</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">invFuel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="c1">-- Get customer class</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">cusClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_CLASS</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARCUST</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKAR_CUSTCODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">BKAR_INV_CUSCOD</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARINV</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKAR_INV_NUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">);</span>

<span class="w">    </span><span class="c1">-- Determine GL account for fuel based on customer class</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">cusClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;GP&#39;</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">fuel_glacct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;40515     &#39;</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">fuel_glacct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;40510     &#39;</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="c1">-- Markpoint 6 before posting</span>
<span class="w">    </span><span class="k">EXEC</span><span class="w"> </span><span class="n">markpoint_6_SaveToGL</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Post to general ledger using `post_to_gl2` function</span>
<span class="w">    </span><span class="k">EXEC</span><span class="w"> </span><span class="n">post_to_gl2</span><span class="w"> </span><span class="o">@</span><span class="n">fuel_glacct</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">invLoc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Fuel from Invoice&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">invFuel</span><span class="p">,</span><span class="w"> </span>
<span class="w">                     </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;FUEL&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Post lock check</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">post_nolock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="n">quit_posting</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="c1">-- Markpoint 6 after successful posting</span>
<span class="w">    </span><span class="k">EXEC</span><span class="w"> </span><span class="n">markpoint_6_SaveToGL</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Update status</span>
<span class="w">    </span><span class="k">EXEC</span><span class="w"> </span><span class="n">post_status</span><span class="p">;</span>

<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">END</span>
<span class="k">GO</span>
</pre></div>
</div>
</section>
<section id="breakdown-of-actions">
<h2>Breakdown of Actions:<a class="headerlink" href="#breakdown-of-actions" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p><strong>Fuel Amount Check</strong>:</p>
<ul class="simple">
<li><p><strong>Condition</strong>: The function checks if the fuel amount (<code class="docutils literal notranslate"><span class="pre">BKAR_INV_FUEL</span></code>) is non-zero. If the fuel amount is <code class="docutils literal notranslate"><span class="pre">0</span></code>, the function exits without making any changes.</p></li>
</ul>
</li>
<li><p><strong>Customer Class Lookup</strong>:</p>
<ul class="simple">
<li><p><strong>Condition</strong>: The function retrieves the customer class (<code class="docutils literal notranslate"><span class="pre">BKAR_CLASS</span></code>) based on the customer code from the invoice.</p></li>
<li><p><strong>Action</strong>: The fuel GL account (<code class="docutils literal notranslate"><span class="pre">fuel_glacct</span></code>) is determined based on the customer class:</p>
<ul>
<li><p>If the customer class is <code class="docutils literal notranslate"><span class="pre">GP</span></code>, the GL account is set to <code class="docutils literal notranslate"><span class="pre">'40515'</span></code>.</p></li>
<li><p>Otherwise, the GL account is set to <code class="docutils literal notranslate"><span class="pre">'40510'</span></code>.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Department Code Assignment</strong>:</p>
<ul class="simple">
<li><p>The fuel department code (<code class="docutils literal notranslate"><span class="pre">BKSY_AR_FRGTDPT</span></code>) is set to the first three characters of the invoice location (<code class="docutils literal notranslate"><span class="pre">BKAR_INV_LOC</span></code>).</p></li>
</ul>
</li>
<li><p><strong>General Ledger Posting</strong>:</p>
<ul class="simple">
<li><p>The function uses the <code class="docutils literal notranslate"><span class="pre">post_to_gl2</span></code> function to post the fuel charges to the general ledger. The function passes the fuel GL account, department, description, fuel amount, invoice number, and other required details to <code class="docutils literal notranslate"><span class="pre">post_to_gl2</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Lock Handling</strong>:</p>
<ul class="simple">
<li><p>If the <code class="docutils literal notranslate"><span class="pre">post_nolock</span></code> flag is not set (<code class="docutils literal notranslate"><span class="pre">post_nolock</span> <span class="pre">=</span> <span class="pre">0</span></code>), the function calls <code class="docutils literal notranslate"><span class="pre">quit_posting</span></code> to terminate further processing.</p></li>
</ul>
</li>
<li><p><strong>Markpoint 6 Execution</strong>:</p>
<ul class="simple">
<li><p>The system executes <code class="docutils literal notranslate"><span class="pre">markpoint_6_SaveToGL</span></code> both before and after the posting action to indicate when the general ledger updates occur.</p></li>
</ul>
</li>
<li><p><strong>Post Status</strong>:</p>
<ul class="simple">
<li><p>After the posting is successful, the function calls <code class="docutils literal notranslate"><span class="pre">post_status</span></code> to ensure the status is updated correctly.</p></li>
</ul>
</li>
</ol>
</section>
<section id="error-handling">
<h2>Error Handling:<a class="headerlink" href="#error-handling" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>If no valid customer class is found or the fuel amount is <code class="docutils literal notranslate"><span class="pre">0</span></code>, the function returns early without posting any fuel charges.</p></li>
<li><p>Errors such as invalid inserts or missing required fields should raise exceptions that log the error and stop further processing.</p></li>
</ul>
</section>
<section id="testing">
<h2>Testing:<a class="headerlink" href="#testing" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p><strong>Test Fuel Posting</strong>:</p>
<ul class="simple">
<li><p>Create test cases where the fuel amount is non-zero to ensure the function correctly posts the fuel charges to the general ledger based on the customer class.</p></li>
<li><p>Ensure that <code class="docutils literal notranslate"><span class="pre">markpoint_6_SaveToGL</span></code> is called correctly both before and after the posting.</p></li>
</ul>
</li>
<li><p><strong>Test Fuel Amount Zero</strong>:</p>
<ul class="simple">
<li><p>Create test cases where the fuel amount is <code class="docutils literal notranslate"><span class="pre">0</span></code> to ensure the function exits without making any changes.</p></li>
</ul>
</li>
<li><p><strong>Test Customer Class ‘GP’</strong>:</p>
<ul class="simple">
<li><p>Create test cases where the customer class is <code class="docutils literal notranslate"><span class="pre">GP</span></code> to ensure the correct GL account (<code class="docutils literal notranslate"><span class="pre">40515</span></code>) is used for posting fuel charges.</p></li>
</ul>
</li>
<li><p><strong>Test Post Lock Handling</strong>:</p>
<ul class="simple">
<li><p>Test scenarios where the <code class="docutils literal notranslate"><span class="pre">post_nolock</span></code> flag is either set or not set to ensure the function correctly calls <code class="docutils literal notranslate"><span class="pre">quit_posting</span></code> when required.</p></li>
</ul>
</li>
</ol>
</section>
<section id="notes">
<h2>Notes:<a class="headerlink" href="#notes" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><strong>Post to General Ledger (<code class="docutils literal notranslate"><span class="pre">post_to_gl2</span></code>)</strong>: This procedure handles the actual posting of fuel charges to the general ledger. Ensure that the procedure is correctly implemented and accepts the following parameters:</p>
<ul>
<li><p>Account</p></li>
<li><p>Department</p></li>
<li><p>Description (Fuel from Invoice)</p></li>
<li><p>Total Amount (Fuel)</p></li>
<li><p>Invoice Number</p></li>
<li><p>Invoice Date</p></li>
<li><p>Posting Type (<code class="docutils literal notranslate"><span class="pre">FUEL</span></code>)</p></li>
<li><p>Customer Code (optional)</p></li>
<li><p>Lock Flag (<code class="docutils literal notranslate"><span class="pre">False</span></code>)</p></li>
<li><p>Confirmation (<code class="docutils literal notranslate"><span class="pre">Y</span></code>)</p></li>
</ul>
</li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="markpoint-5.html" class="btn btn-neutral float-left" title="Markpoint 5: Post Freight Charges" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="markpoint-7.html" class="btn btn-neutral float-right" title="Markpoint 7: Update Inventory Location" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Chris Watkins.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>