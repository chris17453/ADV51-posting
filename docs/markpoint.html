<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mark_point Stored Procedure &mdash; TAS Posting  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Error Log" href="errorlog.html" />
    <link rel="prev" title="All tables" href="all_tables.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            TAS Posting
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="post_so.html">Post_SO</a></li>
<li class="toctree-l1"><a class="reference internal" href="pre-valiation.html">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-1.html">Mark Point 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-3.html">Mark Point 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-4.html">Mark Point 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-5.html">Mark Point 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-6.html">Mark Point 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-7.html">Mark Point 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-8.html">Mark Point 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-9.html">Mark Point 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-10.html">Mark Point 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-11.html">Mark Point 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-12.html">Mark Point 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-13.html">Mark Point 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-14.html">Mark Point 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-15.html">Mark Point 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-16.html">Mark Point 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-17.html">Mark Point 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-18.html">Mark Point 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-19.html">Mark Point 19</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-20.html">Mark Point 20</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-23.html">Mark Point 23</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-24.html">Mark Point 24</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-25.html">Mark Point 25</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-26.html">Mark Point 26</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="post_to_gl2.html">POST_TO_GL2 post_to_gl2</a></li>
<li class="toctree-l1"><a class="reference internal" href="all_tables.html">All Tables</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Markpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="errorlog.html">ErrorLog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">TAS Posting</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><code class="docutils literal notranslate"><span class="pre">mark_point</span></code> Stored Procedure</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/markpoint.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mark-point-stored-procedure">
<h1><code class="docutils literal notranslate"><span class="pre">mark_point</span></code> Stored Procedure<a class="headerlink" href="#mark-point-stored-procedure" title="Link to this heading"></a></h1>
<section id="summary">
<h2><strong>Summary</strong><a class="headerlink" href="#summary" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> stored procedure is responsible for logging specific checkpoints (mark points) during the sales order posting process into the <code class="docutils literal notranslate"><span class="pre">BKSOMARK</span></code> table. Each mark point records essential information, including the mark point identifier, line number, execution status (success or failure), and timestamp. To maintain data integrity and ensure that mark points are logged in the correct sequence, the procedure employs robust transaction management and locking mechanisms. This comprehensive logging facilitates accurate auditing, monitoring, and troubleshooting of the sales order workflow.</p>
</section>
<section id="bksomark-table-structure">
<h2><strong>BKSOMARK Table Structure</strong><a class="headerlink" href="#bksomark-table-structure" title="Link to this heading"></a></h2>
<p>Understanding the structure of the <code class="docutils literal notranslate"><span class="pre">BKSOMARK</span></code> table is crucial for implementing the <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> procedure effectively. Below is the schema based on the provided information:</p>
<ul class="simple">
<li><p><strong>MDS_RECNUM</strong>: Primary key, likely an auto-incrementing integer.</p></li>
<li><p><strong>BKSOMARK_INVNM</strong>: Invoice Number (<code class="docutils literal notranslate"><span class="pre">INT</span></code>).</p></li>
<li><p><strong>BKSOMARK_MARK</strong>: Mark Point Identifier (<code class="docutils literal notranslate"><span class="pre">INT</span></code>).</p></li>
<li><p><strong>BKSOMARK_LINE</strong>: Line Number within the Invoice (<code class="docutils literal notranslate"><span class="pre">FLOAT</span></code>).</p></li>
<li><p><strong>BKSOMARK_DONE</strong>: Execution Status (<code class="docutils literal notranslate"><span class="pre">SMALLINT</span></code>) — <code class="docutils literal notranslate"><span class="pre">1</span></code> for success, <code class="docutils literal notranslate"><span class="pre">0</span></code> for failure.</p></li>
<li><p><strong>BKSOMARK_DATE</strong>: Date of the Mark Point (<code class="docutils literal notranslate"><span class="pre">DATE</span></code>).</p></li>
</ul>
</section>
<section id="t-sql-procedure">
<h2><strong>T-SQL Procedure</strong><a class="headerlink" href="#t-sql-procedure" title="Link to this heading"></a></h2>
<p>Below is the implementation of the <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> stored procedure, incorporating transaction management and locking to ensure sequential logging of mark points.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- =============================================</span>
<span class="c1">-- Author:        Chris Watkins of Watkins Labs</span>
<span class="c1">-- Create date:   YYYY-MM-DD</span>
<span class="c1">-- Description:   Log Mark Points into BKSOMARK Table with Transaction and Locking</span>
<span class="c1">-- =============================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">mark_point</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">@</span><span class="n">invoiceNum</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="o">@</span><span class="n">mark_point</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="o">@</span><span class="n">line_num</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span>
<span class="w">    </span><span class="o">@</span><span class="n">pass_done</span><span class="w"> </span><span class="nb">SMALLINT</span>
<span class="p">)</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">NOCOUNT</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>

<span class="w">    </span><span class="k">BEGIN</span><span class="w"> </span><span class="n">TRY</span>
<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Transaction Management</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="c1">-- Set the isolation level to SERIALIZABLE to prevent phantom reads</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="w"> </span><span class="k">ISOLATION</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SERIALIZABLE</span><span class="p">;</span>
<span class="w">        </span><span class="k">BEGIN</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Parameter Validation</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="c1">-- Validate @invoiceNum (must be a positive integer)</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Invoice number must be a positive integer.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- Validate @mark_point (must be a positive integer)</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">mark_point</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Mark point identifier must be a positive integer.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- Validate @line_num (must be a positive number)</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">line_num</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Line number must be a positive number.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- Validate @pass_done (must be either 0 or 1)</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">pass_done</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Pass done must be either 0 (False) or 1 (True).&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Locking Mechanism</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="c1">-- Acquire an exclusive lock on the BKSOMARK row for the specific invoice</span>
<span class="w">        </span><span class="c1">-- This ensures that no other transactions can insert or modify mark points for the same invoice concurrently</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">dummy</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">dummy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">UPDLOCK</span><span class="p">,</span><span class="w"> </span><span class="n">HOLDLOCK</span><span class="p">)</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKSOMARK_INVNM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Sequential Mark Point Logging</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="c1">-- Retrieve the current maximum mark point for the invoice</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">current_max_mark</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">current_max_mark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">BKSOMARK_MARK</span><span class="p">)</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKSOMARK_INVNM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- Ensure that the new mark_point is greater than the current maximum to maintain order</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">current_max_mark</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">mark_point</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">@</span><span class="n">current_max_mark</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Mark point identifier must be greater than the existing maximum mark point for the invoice.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Insert or Update Mark Point</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">            </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span>
<span class="w">            </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKSOMARK_INVNM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="c1">-- Update existing row with the new mark point</span>
<span class="w">            </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">BKSOMARK</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span>
<span class="w">                </span><span class="n">BKSOMARK_MARK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">mark_point</span><span class="p">,</span>
<span class="w">                </span><span class="n">BKSOMARK_LINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">line_num</span><span class="p">,</span>
<span class="w">                </span><span class="n">BKSOMARK_DONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">pass_done</span><span class="p">,</span>
<span class="w">                </span><span class="n">BKSOMARK_DATE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">)</span>
<span class="w">            </span><span class="k">WHERE</span><span class="w"> </span>
<span class="w">                </span><span class="n">BKSOMARK_INVNM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>
<span class="w">        </span><span class="k">ELSE</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="c1">-- Insert a new row if it does not exist</span>
<span class="w">            </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="p">(</span>
<span class="w">                </span><span class="n">BKSOMARK_INVNM</span><span class="p">,</span>
<span class="w">                </span><span class="n">BKSOMARK_MARK</span><span class="p">,</span>
<span class="w">                </span><span class="n">BKSOMARK_LINE</span><span class="p">,</span>
<span class="w">                </span><span class="n">BKSOMARK_DONE</span><span class="p">,</span>
<span class="w">                </span><span class="n">BKSOMARK_DATE</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">            </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span>
<span class="w">                </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span>
<span class="w">                </span><span class="o">@</span><span class="n">mark_point</span><span class="p">,</span>
<span class="w">                </span><span class="o">@</span><span class="n">line_num</span><span class="p">,</span>
<span class="w">                </span><span class="o">@</span><span class="n">pass_done</span><span class="p">,</span>
<span class="w">                </span><span class="k">CAST</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">)</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Commit Transaction</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="k">COMMIT</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>

<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">TRY</span>
<span class="w">    </span><span class="k">BEGIN</span><span class="w"> </span><span class="n">CATCH</span>
<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Error Handling</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="c1">-- Rollback the transaction if it&#39;s still active</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">XACT_STATE</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- Retrieve error information</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorMessage</span><span class="w"> </span><span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ERROR_MESSAGE</span><span class="p">();</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorSeverity</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ERROR_SEVERITY</span><span class="p">();</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorState</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ERROR_STATE</span><span class="p">();</span>

<span class="w">        </span><span class="c1">-- Optionally, log the error to an ErrorLog table</span>
<span class="w">        </span><span class="c1">-- Uncomment and modify the following lines if an ErrorLog table exists</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">        INSERT INTO dbo.ErrorLog (ErrorMessage, ErrorSeverity, ErrorState, ErrorTime)</span>
<span class="cm">        VALUES (@ErrorMessage, @ErrorSeverity, @ErrorState, GETDATE());</span>
<span class="cm">        */</span>

<span class="w">        </span><span class="c1">-- Re-raise the error to the calling environment</span>
<span class="w">        </span><span class="n">RAISERROR</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">ErrorMessage</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorSeverity</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorState</span><span class="p">);</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">CATCH</span>
<span class="k">END</span><span class="p">;</span>
<span class="k">GO</span>
</pre></div>
</div>
</section>
<section id="detailed-breakdown-of-actions">
<h2><strong>Detailed Breakdown of Actions</strong><a class="headerlink" href="#detailed-breakdown-of-actions" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p><strong>Parameter Definitions:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;invoiceNum</span> <span class="pre">INT</span></code>: The invoice number associated with the sales order.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;mark_point</span> <span class="pre">INT</span></code>: The identifier for the specific mark point being logged.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;line_num</span> <span class="pre">FLOAT</span></code>: The line number within the invoice where the mark point is being logged.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;pass_done</span> <span class="pre">SMALLINT</span></code>: A boolean indicating the success (<code class="docutils literal notranslate"><span class="pre">1</span></code>) or failure (<code class="docutils literal notranslate"><span class="pre">0</span></code>) of the mark point.</p></li>
</ul>
</li>
<li><p><strong>Transaction Management:</strong></p>
<ul class="simple">
<li><p><strong>Isolation Level:</strong> Set to <code class="docutils literal notranslate"><span class="pre">SERIALIZABLE</span></code> to prevent phantom reads and ensure complete isolation from other transactions.</p></li>
<li><p><strong>Transaction Start:</strong> Begins a transaction to encapsulate all operations, ensuring atomicity.</p></li>
</ul>
</li>
<li><p><strong>Parameter Validation:</strong></p>
<ul class="simple">
<li><p><strong>Invoice Number (<code class="docutils literal notranslate"><span class="pre">&#64;invoiceNum</span></code>):</strong> Must be a positive integer.</p></li>
<li><p><strong>Mark Point Identifier (<code class="docutils literal notranslate"><span class="pre">&#64;mark_point</span></code>):</strong> Must be a positive integer.</p></li>
<li><p><strong>Line Number (<code class="docutils literal notranslate"><span class="pre">&#64;line_num</span></code>):</strong> Must be a positive number.</p></li>
<li><p><strong>Pass Done (<code class="docutils literal notranslate"><span class="pre">&#64;pass_done</span></code>):</strong> Must be either <code class="docutils literal notranslate"><span class="pre">0</span></code> (False) or <code class="docutils literal notranslate"><span class="pre">1</span></code> (True).</p></li>
</ul>
</li>
<li><p><strong>Locking Mechanism:</strong></p>
<ul class="simple">
<li><p><strong>Purpose:</strong> Prevents concurrent transactions from inserting or modifying mark points for the same invoice, ensuring that mark points are logged in the correct sequence.</p></li>
<li><p><strong>Implementation:</strong> Uses table hints <code class="docutils literal notranslate"><span class="pre">UPDLOCK</span></code> and <code class="docutils literal notranslate"><span class="pre">HOLDLOCK</span></code> in a dummy <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> statement to acquire an exclusive lock on the relevant rows.</p></li>
<li><p><strong>Dummy Variable:</strong> <code class="docutils literal notranslate"><span class="pre">&#64;dummy</span> <span class="pre">INT</span></code> is used to store the result of the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> statement, which serves solely to acquire the lock.</p></li>
</ul>
</li>
<li><p><strong>Sequential Mark Point Logging:</strong></p>
<ul class="simple">
<li><p><strong>Purpose:</strong> Ensures that each new mark point is sequentially higher than the existing maximum mark point for the invoice.</p></li>
<li><p><strong>Implementation:</strong> Retrieves the current maximum <code class="docutils literal notranslate"><span class="pre">BKSOMARK_MARK</span></code> for the invoice and validates that the new <code class="docutils literal notranslate"><span class="pre">&#64;mark_point</span></code> is greater.</p></li>
</ul>
</li>
<li><p><strong>Insert or Update Mark Point:</strong></p>
<ul class="simple">
<li><p><strong>Action:</strong></p>
<ul>
<li><p><strong>Update Existing Row:</strong> If a row for the invoice already exists, update it with the new mark point details.</p></li>
<li><p><strong>Insert New Row:</strong> If no row exists for the invoice, insert a new record with the provided mark point details.</p></li>
</ul>
</li>
<li><p><strong>Fields Updated/Inserted:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">BKSOMARK_MARK</span></code>: Mark Point Identifier.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BKSOMARK_LINE</span></code>: Line Number.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BKSOMARK_DONE</span></code>: Execution Status.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BKSOMARK_DATE</span></code>: Current Date (<code class="docutils literal notranslate"><span class="pre">CAST(GETDATE()</span> <span class="pre">AS</span> <span class="pre">DATE)</span></code>).</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Transaction Commit:</strong></p>
<ul class="simple">
<li><p><strong>Action:</strong> Commits the transaction, making all changes permanent.</p></li>
</ul>
</li>
<li><p><strong>Error Handling with TRY…CATCH:</strong></p>
<ul class="simple">
<li><p><strong>TRY Block:</strong> Contains the main logic, including transaction management, parameter validation, locking, and data insertion/updating.</p></li>
<li><p><strong>CATCH Block:</strong></p>
<ul>
<li><p><strong>Rollback:</strong> Rolls back the transaction if it’s still active.</p></li>
<li><p><strong>Error Retrieval:</strong> Captures error details using <code class="docutils literal notranslate"><span class="pre">ERROR_MESSAGE()</span></code>, <code class="docutils literal notranslate"><span class="pre">ERROR_SEVERITY()</span></code>, and <code class="docutils literal notranslate"><span class="pre">ERROR_STATE()</span></code>.</p></li>
<li><p><strong>Optional Error Logging:</strong> Provides commented-out code to log errors into an <code class="docutils literal notranslate"><span class="pre">ErrorLog</span></code> table if such a table exists.</p></li>
<li><p><strong>Error Raising:</strong> Re-raises the error to the calling environment using <code class="docutils literal notranslate"><span class="pre">RAISERROR</span></code>.</p></li>
</ul>
</li>
</ul>
</li>
</ol>
</section>
<section id="recommendations">
<h2><strong>Recommendations</strong><a class="headerlink" href="#recommendations" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p><strong>Input Validation Enhancements:</strong></p>
<ul>
<li><p><strong>Sanitization:</strong> While parameters are strongly typed, additional checks can be implemented to ensure data integrity.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Example: Ensure @invoiceNum contains only digits</span>
<span class="k">IF</span><span class="w"> </span><span class="n">PATINDEX</span><span class="p">(</span><span class="s1">&#39;%[^0-9]%&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">invoiceNum</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Invalid characters in Invoice Number.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">    </span><span class="k">RETURN</span><span class="p">;</span>
<span class="k">END</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p><strong>Indexing:</strong></p>
<ul>
<li><p><strong>Performance Optimization:</strong> Create indexes on columns frequently used in queries to enhance performance.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">IDX_BKSOMARK_INVNM</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="p">(</span><span class="n">BKSOMARK_INVNM</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">IDX_BKSOMARK_MARK</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="p">(</span><span class="n">BKSOMARK_MARK</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">IDX_BKSOMARK_LINE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="p">(</span><span class="n">BKSOMARK_LINE</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><strong>Benefits:</strong> Improves the speed of data retrieval operations, especially for large datasets.</p></li>
</ul>
</li>
<li><p><strong>Error Logging Enhancements:</strong></p>
<ul>
<li><p><strong>Purpose:</strong> Maintain a persistent record of errors for auditing and troubleshooting.</p></li>
<li><p><strong>Implementation:</strong></p>
<ul>
<li><p><strong>Create an <code class="docutils literal notranslate"><span class="pre">ErrorLog</span></code> Table:</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">ErrorLog</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">ErrorID</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">ErrorMessage</span><span class="w"> </span><span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">4000</span><span class="p">),</span>
<span class="w">    </span><span class="n">ErrorSeverity</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">ErrorState</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="n">ErrorTime</span><span class="w"> </span><span class="n">DATETIME</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">()</span>
<span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><strong>Log Errors in the CATCH Block:</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">ErrorLog</span><span class="w"> </span><span class="p">(</span><span class="n">ErrorMessage</span><span class="p">,</span><span class="w"> </span><span class="n">ErrorSeverity</span><span class="p">,</span><span class="w"> </span><span class="n">ErrorState</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">ErrorMessage</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorSeverity</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorState</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><strong>Enable Error Logging:</strong> Uncomment the relevant lines in the CATCH block to activate error logging.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Security Considerations:</strong></p>
<ul>
<li><p><strong>Permissions:</strong> Restrict execute permissions on the <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> procedure to authorized roles only.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">GRANT</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">mark_point</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="p">[</span><span class="n">SalesProcessorRole</span><span class="p">];</span>
</pre></div>
</div>
</li>
<li><p><strong>Least Privilege:</strong> Ensure that users executing the procedure have only the necessary permissions to perform required operations on the <code class="docutils literal notranslate"><span class="pre">BKSOMARK</span></code> table.</p></li>
</ul>
</li>
<li><p><strong>Performance Optimization:</strong></p>
<ul class="simple">
<li><p><strong>Batch Inserts:</strong> If multiple mark points need to be logged simultaneously, consider batching insert operations to reduce transaction overhead.</p></li>
<li><p><strong>Set-Based Operations:</strong> Utilize set-based operations instead of row-by-row processing where feasible to enhance performance.</p></li>
</ul>
</li>
<li><p><strong>Concurrency Control:</strong></p>
<ul class="simple">
<li><p><strong>Isolation Levels:</strong> Using <code class="docutils literal notranslate"><span class="pre">SERIALIZABLE</span></code> isolation level ensures complete isolation from other transactions, preventing race conditions and maintaining data consistency.</p></li>
<li><p><strong>Locking Hints:</strong> Employing <code class="docutils literal notranslate"><span class="pre">UPDLOCK</span></code> and <code class="docutils literal notranslate"><span class="pre">HOLDLOCK</span></code> in the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> statement acquires an exclusive lock on the relevant rows, ensuring that no other transactions can modify them until the current transaction is complete.</p></li>
</ul>
</li>
<li><p><strong>Idempotency:</strong></p>
<ul>
<li><p><strong>Design Consideration:</strong> Ensure that re-executing the <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> procedure with the same parameters does not result in duplicate entries.</p></li>
<li><p><strong>Implementation Suggestion:</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKSOMARK_INVNM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">BKSOMARK_MARK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">mark_point</span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">BKSOMARK_LINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">line_num</span>
<span class="p">)</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="n">BKSOMARK_INVNM</span><span class="p">,</span>
<span class="w">        </span><span class="n">BKSOMARK_MARK</span><span class="p">,</span>
<span class="w">        </span><span class="n">BKSOMARK_LINE</span><span class="p">,</span>
<span class="w">        </span><span class="n">BKSOMARK_DONE</span><span class="p">,</span>
<span class="w">        </span><span class="n">BKSOMARK_DATE</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span>
<span class="w">        </span><span class="o">@</span><span class="n">mark_point</span><span class="p">,</span>
<span class="w">        </span><span class="o">@</span><span class="n">line_num</span><span class="p">,</span>
<span class="w">        </span><span class="o">@</span><span class="n">pass_done</span><span class="p">,</span>
<span class="w">        </span><span class="k">CAST</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="k">END</span>
<span class="k">ELSE</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="c1">-- Optionally, update the existing record if needed</span>
<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">BKSOMARK</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span>
<span class="w">        </span><span class="n">BKSOMARK_DONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">pass_done</span><span class="p">,</span>
<span class="w">        </span><span class="n">BKSOMARK_DATE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">)</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span>
<span class="w">        </span><span class="n">BKSOMARK_INVNM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span>
<span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="n">BKSOMARK_MARK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">mark_point</span>
<span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="n">BKSOMARK_LINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">line_num</span><span class="p">;</span>
<span class="k">END</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p><strong>Documentation:</strong></p>
<ul class="simple">
<li><p><strong>Clarity:</strong> Maintain clear and comprehensive documentation within the procedure to facilitate future maintenance and onboarding of new team members.</p></li>
<li><p><strong>Comments:</strong> Use inline comments to explain complex logic or business rules implemented within the procedure.</p></li>
</ul>
</li>
<li><p><strong>Extensibility:</strong></p>
<ul class="simple">
<li><p><strong>Future Fields:</strong> If the <code class="docutils literal notranslate"><span class="pre">BKSOMARK</span></code> table is updated to include additional fields in the future, update the <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> procedure accordingly to capture and log the new information.</p></li>
</ul>
</li>
</ol>
</section>
<section id="testing-guidelines">
<h2><strong>Testing Guidelines</strong><a class="headerlink" href="#testing-guidelines" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p><strong>Unit Testing:</strong></p>
<ul class="simple">
<li><p><strong>Objective:</strong> Validate each component of the procedure individually.</p></li>
<li><p><strong>Test Cases:</strong></p>
<ul>
<li><p><strong>Valid Inputs:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;invoiceNum</span></code> exists in <code class="docutils literal notranslate"><span class="pre">BKARINV</span></code>.</p></li>
<li><p>Valid <code class="docutils literal notranslate"><span class="pre">&#64;mark_point</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;line_num</span></code> values.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;pass_done</span></code> set to <code class="docutils literal notranslate"><span class="pre">1</span></code> (success) and <code class="docutils literal notranslate"><span class="pre">0</span></code> (failure).</p></li>
</ul>
</li>
<li><p><strong>Invalid Inputs:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;invoiceNum</span></code> is a negative integer or zero.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;mark_point</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;line_num</span></code> are non-positive.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;pass_done</span></code> is neither <code class="docutils literal notranslate"><span class="pre">0</span></code> nor <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Integration Testing:</strong></p>
<ul class="simple">
<li><p><strong>Objective:</strong> Ensure that the procedure interacts correctly with other system components.</p></li>
<li><p><strong>Test Cases:</strong></p>
<ul>
<li><p>Execute the procedure within the <code class="docutils literal notranslate"><span class="pre">post_so</span></code> workflow and verify that mark points are logged accurately.</p></li>
<li><p>Simulate concurrent executions to test concurrency controls.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Error Handling Testing:</strong></p>
<ul class="simple">
<li><p><strong>Objective:</strong> Confirm that errors are handled gracefully without leaving the system in an inconsistent state.</p></li>
<li><p><strong>Test Cases:</strong></p>
<ul>
<li><p>Provide invalid parameters to trigger errors.</p></li>
<li><p>Simulate failures in dependent tables or procedures.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Performance Testing:</strong></p>
<ul class="simple">
<li><p><strong>Objective:</strong> Assess the procedure’s performance under various loads.</p></li>
<li><p><strong>Test Cases:</strong></p>
<ul>
<li><p>Execute the procedure with a large number of mark points to evaluate scalability.</p></li>
<li><p>Monitor execution time and resource utilization.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Security Testing:</strong></p>
<ul class="simple">
<li><p><strong>Objective:</strong> Ensure that the procedure is secure against unauthorized access and SQL injection.</p></li>
<li><p><strong>Test Cases:</strong></p>
<ul>
<li><p>Attempt to execute the procedure with unauthorized roles.</p></li>
<li><p>Provide malicious input to test input validation.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Regression Testing:</strong></p>
<ul class="simple">
<li><p><strong>Objective:</strong> Verify that new changes do not adversely affect existing functionalities.</p></li>
<li><p><strong>Test Cases:</strong></p>
<ul>
<li><p>Re-run previous test cases after making modifications to ensure consistent behavior.</p></li>
</ul>
</li>
</ul>
</li>
</ol>
</section>
<section id="example-usage">
<h2><strong>Example Usage</strong><a class="headerlink" href="#example-usage" title="Link to this heading"></a></h2>
<p>To execute the <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> stored procedure, use the following command, replacing the placeholders with actual values:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">mark_point</span><span class="w"> </span>
<span class="w">    </span><span class="o">@</span><span class="n">invoiceNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123456</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="o">@</span><span class="n">mark_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="o">@</span><span class="n">line_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="o">@</span><span class="n">pass_done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="maintenance-and-future-enhancements">
<h2><strong>Maintenance and Future Enhancements</strong><a class="headerlink" href="#maintenance-and-future-enhancements" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p><strong>Procedure Modularity:</strong></p>
<ul class="simple">
<li><p><strong>Design Principle:</strong> Keep the procedure modular to facilitate easier maintenance and potential reuse in other processes.</p></li>
<li><p><strong>Implementation:</strong> Ensure that each mark point corresponds to a specific and distinct aspect of the sales order processing.</p></li>
</ul>
</li>
<li><p><strong>Logging Enhancements:</strong></p>
<ul class="simple">
<li><p><strong>Detailed Logs:</strong> Enhance the logging mechanism to capture additional context or metadata as required.</p></li>
<li><p><strong>Audit Trails:</strong> Maintain comprehensive audit trails for compliance and historical analysis.</p></li>
</ul>
</li>
<li><p><strong>Regular Reviews:</strong></p>
<ul class="simple">
<li><p><strong>Objective:</strong> Periodically review and update the procedure to accommodate changes in business rules, system architecture, or compliance requirements.</p></li>
<li><p><strong>Action:</strong> Schedule regular code reviews and updates in collaboration with the development and QA teams.</p></li>
</ul>
</li>
<li><p><strong>Backup and Recovery:</strong></p>
<ul class="simple">
<li><p><strong>Objective:</strong> Ensure data integrity and availability by implementing robust backup and recovery strategies.</p></li>
<li><p><strong>Action:</strong> Regularly back up the <code class="docutils literal notranslate"><span class="pre">BKSOMARK</span></code> table and related database components.</p></li>
</ul>
</li>
<li><p><strong>Documentation Updates:</strong></p>
<ul class="simple">
<li><p><strong>Objective:</strong> Keep the documentation up-to-date with any changes made to the procedure.</p></li>
<li><p><strong>Action:</strong> Implement a versioning system for documentation to track changes over time.</p></li>
</ul>
</li>
<li><p><strong>Performance Monitoring:</strong></p>
<ul class="simple">
<li><p><strong>Objective:</strong> Continuously monitor the procedure’s performance to identify and address any bottlenecks.</p></li>
<li><p><strong>Action:</strong> Use SQL Server’s monitoring tools to analyze execution plans and optimize queries as needed.</p></li>
</ul>
</li>
</ol>
</section>
<section id="conclusion">
<h2><strong>Conclusion</strong><a class="headerlink" href="#conclusion" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> stored procedure is a pivotal component for logging and tracking the execution of various checkpoints during the sales order posting process. By adhering to best practices in its implementation, including comprehensive validation, robust error handling, and detailed logging with appropriate transaction management and locking mechanisms, this procedure ensures the integrity, reliability, and auditability of your sales order system.</p>
<p><strong>Key Benefits:</strong></p>
<ul class="simple">
<li><p><strong>Comprehensive Auditing:</strong> Detailed logging of each mark point facilitates thorough auditing and tracking.</p></li>
<li><p><strong>Data Integrity:</strong> Rigorous validation steps ensure that only valid and consistent data is processed.</p></li>
<li><p><strong>Error Resilience:</strong> Robust error handling mechanisms prevent inconsistent states and facilitate troubleshooting.</p></li>
<li><p><strong>Scalability:</strong> Optimized for performance, allowing efficient processing of large volumes of sales orders.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="all_tables.html" class="btn btn-neutral float-left" title="All tables" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="errorlog.html" class="btn btn-neutral float-right" title="Error Log" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Chris Watkins.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>