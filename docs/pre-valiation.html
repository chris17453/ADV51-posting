<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
        <title>Pre-validation SQL Procedures &mdash; TAS Posting  documentation</title>
    
    <link rel="stylesheet" type="text/css" href="_static/dist/fontawesome.css" />
      <link rel="stylesheet" type="text/css" href="_static/dist/theme.css?v=ea6a6c20" />
            <link rel="index" title="Index" href="genindex.html" />
            <link rel="search" title="Search" href="search.html" />
            <link rel="top" title="TAS Posting  documentation" href="#" />
            <link rel="next" title="Markpoint 1 AND 2: Save to Accounts Receivable Payment Record" href="markpoint-1.html" />
            <link rel="prev" title="post_so Stored Procedure Documentation" href="post_so.html" />
    </head>
<body>
    <script type="text/javascript" src="_static/dist/blocking.js"></script>
    <header class="container-fluid bg-primary">
        <a class="btn btn-sm btn-light skip-to-content-link" href="#main">Skip to content</a>
        <div class="container-fluid">
            <div class="navbar navbar-expand-lg navbar-dark font-weight-bold">
                    <a href="index.html"
                        title="Wagtail"
                        class="logo navbar-brand"
                    >
                        <img src="_static/img/wagtail-logo-new.svg" width="45" height="59" alt="Wagtail"
                            class="logo-img"
                        />
                        ADV 5.1 Posting Migration
                    </a>
                
                
                <button class="navbar-toggler btn btn-primary d-lg-none" type="button" data-toggle="collapse" data-target="#collapseSidebar" aria-expanded="false" aria-controls="collapseExample">
                    <span class="navbar-toggler-icon"></span>
                    <span class="sr-only">menu</span>
                </button>
            </div>
        </div>
    </header>
    <div class="container-fluid">
        <div class="row">
            <aside class="col-12 col-lg-3 sidebar-container">
                <div id="collapseSidebar" class="collapse sticky-top d-lg-block pt-5 pr-lg-4">
<div id="searchbox" class="searchbox mb-6 px-1" role="search">
    <form id="search-form" action="search.html" autocomplete="off" method="get" role="search">
        <div class="input-group">
            <div class="input-group-prepend">
                <div class="input-group-text border-right-0 bg-white py-3 pl-3 pr-2"><span class="fas fa-search"></span></div>
            </div>
            <input class="form-control py-3 pr-3 pl-1 h-100 border-left-0" type="search" name="q" placeholder="Search documentation" aria-label="Search documentation" id="searchinput" />
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div><div class="site-toc">
    <nav class="toc mt-3" aria-label="Main menu">
        <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="post_so.html"><code class="docutils literal notranslate"><span class="pre">post_so</span></code> Stored Procedure Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="post_so.html#helper-functions">Helper functions</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-1.html">Mark Point 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-3.html">Mark Point 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-4.html">Mark Point 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-5.html">Mark Point 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-6.html">Mark Point 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-7.html">Mark Point 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-8.html">Mark Point 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-9.html">Mark Point 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-10.html">Mark Point 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-11.html">Mark Point 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-12.html">Mark Point 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-13.html">Mark Point 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-14.html">Mark Point 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-15.html">Mark Point 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-16.html">Mark Point 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-17.html">Mark Point 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-18.html">Mark Point 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-19.html">Mark Point 19</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-20.html">Mark Point 20</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-23.html">Mark Point 23</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-24.html">Mark Point 24</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-25.html">Mark Point 25</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-26.html">Mark Point 26</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_invoice_from_history.html">create_invoice_from_history</a></li>
<li class="toctree-l1"><a class="reference internal" href="post_to_gl2.html">post_to_gl2</a></li>
<li class="toctree-l1"><a class="reference internal" href="all_tables.html">All Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint.html">Markpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="errorlog.html">ErrorLog</a></li>
</ul>

    </nav>
    <template data-toggle-item-template>
        <button class="btn btn-sm btn-link toctree-expand" type="button">
            <span class="sr-only">Toggle menu contents</span>
        </button>
    </template>
</div>
                    <div class="d-lg-none border-bottom">
                        
                    </div>
                </div>
            </aside>
            <div class="col-12 col-lg-9 pt-5">
                <header class="row align-items-baseline">
                    <div class="col">
                        <nav aria-label="breadcrumb">
    <ol class="breadcrumb m-0 p-0 bg-transparent">
        <li class="breadcrumb-item"><a href="index.html">Docs</a></li>
        <li class="breadcrumb-item active" aria-current="page">Pre-validation SQL Procedures</li>
    </ol>
</nav>
                    </div>
                    <div class="col-sm-12 col-lg-auto mt-3 mt-lg-3">
                        <noscript>
                            <p>JavaScript is required to toggle light/dark mode..</p>
                        </noscript>
                        <button id="wagtail-theme" class="btn btn-sm btn-light text-decoration-none" type="button">
                            <span class="dark-only"><i class="fas fa-sun"></i> Light mode</span>
                            <span class="light-only"><i class="fas fa-moon"></i> Dark mode</span>
                        </button>
    <a class="btn btn-sm btn-light text-decoration-none" href="https://github.com/wagtail/sphinx_wagtail_theme/blob/main/docs/pre-valiation.md" rel="nofollow">
        <span class="btn-icon"><span class="fab fa-github"></span></span>
        <span class="btn-text">Edit on GitHub</span>
    </a>
    <a class="btn btn-sm btn-light text-decoration-none" href="_sources/pre-valiation.md.txt" rel="nofollow">
        <span class="btn-icon"><span class="fas fa-code"></span></span>
        <span class="btn-text">View source</span>
    </a>
                        
                    </div>
                </header>
                <div class="row" >
                    <div class="col-12">
                        <hr class="w-100 my-4">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-lg-9 order-last order-lg-first rst-content">
                        <main role="main" id="main">
    <section id="pre-validation-sql-procedures">
<h1>Pre-validation SQL Procedures<a class="headerlink" href="#pre-validation-sql-procedures" title="Link to this heading">¶</a></h1>
<section id="check-invoice-status">
<h2>1. <strong>Check Invoice Status</strong><a class="headerlink" href="#check-invoice-status" title="Link to this heading">¶</a></h2>
<section id="summary">
<h3><strong>Summary</strong><a class="headerlink" href="#summary" title="Link to this heading">¶</a></h3>
<p>This function verifies whether an invoice is eligible for processing by checking if it has already been processed or marked for deletion. It ensures that only valid invoices proceed through the posting process.</p>
</section>
<section id="t-sql-function">
<h3><strong>T-SQL Function</strong><a class="headerlink" href="#t-sql-function" title="Link to this heading">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">check_invoice_status</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">BIT</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="nb">BIT</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Check if the invoice exists and has been processed or marked for deletion</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARINV</span><span class="w"> </span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKAR_INV_INVNO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span>
<span class="w">          </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">BKAR_INV_STATUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;processed&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">BKAR_INV_INVCD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Invalid status</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Valid for processing</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="k">GO</span>
</pre></div>
</div>
<hr class="docutils" />
</section>
</section>
<section id="customer-record-validation">
<h2>2. <strong>Customer Record Validation</strong><a class="headerlink" href="#customer-record-validation" title="Link to this heading">¶</a></h2>
<section id="id1">
<h3><strong>Summary</strong><a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>This function validates a customer’s eligibility by ensuring the customer exists, is not on hold, and has not exceeded their credit limit. It helps prevent processing invoices for invalid or risky customers.</p>
</section>
<section id="id2">
<h3><strong>T-SQL Function</strong><a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">validate_customer</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">customer_code</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">BIT</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="nb">BIT</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Combined condition to check if customer exists and is valid</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARCUST</span><span class="w"> </span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKAR_CUST_CUSTCODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">customer_code</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Customer does not exist</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARCUST</span><span class="w"> </span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKAR_CUST_CUSTCODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">customer_code</span><span class="w"> </span>
<span class="w">          </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">BKAR_CUST_HOLD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">BKAR_CUST_BALANCE</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">BKAR_CUST_CREDIT_LIMIT</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Customer on hold or exceeds credit limit</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Valid customer</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="k">GO</span>
</pre></div>
</div>
<hr class="docutils" />
</section>
</section>
<section id="inventory-validation">
<h2>3. <strong>Inventory Validation</strong><a class="headerlink" href="#inventory-validation" title="Link to this heading">¶</a></h2>
<section id="id3">
<h3><strong>Summary</strong><a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<p>This function ensures that all inventory items in an invoice exist and have sufficient stock to fulfill the order. It prevents the processing of invoices that cannot be fully satisfied due to inventory constraints.</p>
</section>
<section id="id4">
<h3><strong>T-SQL Function</strong><a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">validate_inventory</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">BIT</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="nb">BIT</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Check if any inventory item in the invoice does not exist</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARINVL</span><span class="w"> </span><span class="n">li</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">BKAR_INV_INVNO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span>
<span class="w">          </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">              </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKICMSTR</span><span class="w"> </span><span class="n">inv</span><span class="w"> </span>
<span class="w">              </span><span class="k">WHERE</span><span class="w"> </span><span class="n">inv</span><span class="p">.</span><span class="n">BKIC_MSTR_ITEMCODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">BKAR_INV_ITEMCODE</span>
<span class="w">          </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Item does not exist</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="c1">-- Check if any inventory item has insufficient stock</span>
<span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARINVL</span><span class="w"> </span><span class="n">li</span><span class="w"> </span>
<span class="w">        </span><span class="k">JOIN</span><span class="w"> </span><span class="n">BKICMSTR</span><span class="w"> </span><span class="n">inv</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">BKAR_INV_ITEMCODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inv</span><span class="p">.</span><span class="n">BKIC_MSTR_ITEMCODE</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">BKAR_INV_INVNO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span>
<span class="w">          </span><span class="k">AND</span><span class="w"> </span><span class="n">inv</span><span class="p">.</span><span class="n">BKIC_MSTR_QTY_ON_HAND</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">BKAR_INV_QTY</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Not enough stock</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Inventory validated</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="k">GO</span>
</pre></div>
</div>
<hr class="docutils" />
</section>
</section>
<section id="tax-validation">
<h2>4. <strong>Tax Validation</strong><a class="headerlink" href="#tax-validation" title="Link to this heading">¶</a></h2>
<section id="id5">
<h3><strong>Summary</strong><a class="headerlink" href="#id5" title="Link to this heading">¶</a></h3>
<p>This function verifies that the tax amounts calculated on an invoice match the expected tax values based on predefined tax codes. It ensures tax accuracy and compliance with tax regulations.</p>
</section>
<section id="id6">
<h3><strong>T-SQL Function</strong><a class="headerlink" href="#id6" title="Link to this heading">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">validate_tax</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">BIT</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="nb">BIT</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Validate that taxes match the expected values, considering NULLs</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARINV</span><span class="w"> </span><span class="n">inv</span>
<span class="w">        </span><span class="k">JOIN</span><span class="w"> </span><span class="n">BKICTAX</span><span class="w"> </span><span class="n">tax</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">inv</span><span class="p">.</span><span class="n">BKAR_INV_TAXCODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tax</span><span class="p">.</span><span class="n">BKIC_TAX_CODE</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">inv</span><span class="p">.</span><span class="n">BKAR_INV_INVNO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span>
<span class="w">          </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span>
<span class="w">                </span><span class="n">inv</span><span class="p">.</span><span class="n">BKAR_INV_TAX_TOTAL</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span>
<span class="w">                </span><span class="k">OR</span><span class="w"> </span><span class="n">tax</span><span class="p">.</span><span class="n">BKIC_TAX_CALC_TAX</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span>
<span class="w">                </span><span class="k">OR</span><span class="w"> </span><span class="n">inv</span><span class="p">.</span><span class="n">BKAR_INV_TAX_TOTAL</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">tax</span><span class="p">.</span><span class="n">BKIC_TAX_CALC_TAX</span>
<span class="w">              </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Tax mismatch or NULL values present</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Tax is valid</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="k">GO</span>
</pre></div>
</div>
<hr class="docutils" />
</section>
</section>
<section id="payment-terms-validation">
<h2>5. <strong>Payment Terms Validation</strong><a class="headerlink" href="#payment-terms-validation" title="Link to this heading">¶</a></h2>
<section id="id7">
<h3><strong>Summary</strong><a class="headerlink" href="#id7" title="Link to this heading">¶</a></h3>
<p>This function ensures that the payment terms specified on an invoice align with the customer’s default payment terms. It prevents discrepancies that could lead to payment delays or accounting errors.</p>
</section>
<section id="id8">
<h3><strong>T-SQL Function</strong><a class="headerlink" href="#id8" title="Link to this heading">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">validate_payment_terms</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">BIT</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="nb">BIT</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Check if the payment terms are valid for the customer, considering case insensitivity and NULLs</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARINV</span><span class="w"> </span><span class="n">inv</span>
<span class="w">        </span><span class="k">JOIN</span><span class="w"> </span><span class="n">BKARCUST</span><span class="w"> </span><span class="n">cust</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">inv</span><span class="p">.</span><span class="n">BKAR_INV_CUSTCODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cust</span><span class="p">.</span><span class="n">BKAR_CUST_CUSTCODE</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">inv</span><span class="p">.</span><span class="n">BKAR_INV_INVNO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span>
<span class="w">          </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span>
<span class="w">                </span><span class="n">cust</span><span class="p">.</span><span class="n">BKAR_CUST_PAY_TERMS</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span>
<span class="w">                </span><span class="k">OR</span><span class="w"> </span><span class="n">inv</span><span class="p">.</span><span class="n">BKAR_INV_PAY_TERMS</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span>
<span class="w">                </span><span class="k">OR</span><span class="w"> </span><span class="k">UPPER</span><span class="p">(</span><span class="n">cust</span><span class="p">.</span><span class="n">BKAR_CUST_PAY_TERMS</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="k">UPPER</span><span class="p">(</span><span class="n">inv</span><span class="p">.</span><span class="n">BKAR_INV_PAY_TERMS</span><span class="p">)</span>
<span class="w">              </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Payment terms mismatch or NULL values present</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Payment terms valid</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="k">GO</span>
</pre></div>
</div>
<hr class="docutils" />
</section>
</section>
<section id="salesperson-record-validation">
<h2>6. <strong>Salesperson Record Validation</strong><a class="headerlink" href="#salesperson-record-validation" title="Link to this heading">¶</a></h2>
<section id="id9">
<h3><strong>Summary</strong><a class="headerlink" href="#id9" title="Link to this heading">¶</a></h3>
<p>This function verifies that a salesperson associated with an invoice exists and is currently active. It prevents assigning sales efforts to inactive or non-existent sales representatives.</p>
</section>
<section id="id10">
<h3><strong>T-SQL Function</strong><a class="headerlink" href="#id10" title="Link to this heading">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">validate_salesperson</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">salesperson_code</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">BIT</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="nb">BIT</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Combined condition to check if salesperson exists and is active</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSLSREP</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKSLS_REP_CODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">salesperson_code</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Salesperson does not exist</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSLSREP</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKSLS_REP_CODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">salesperson_code</span><span class="w"> </span>
<span class="w">          </span><span class="k">AND</span><span class="w"> </span><span class="n">BKSLS_REP_ACTV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;N&#39;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Salesperson inactive</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Valid salesperson</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="k">GO</span>
</pre></div>
</div>
<hr class="docutils" />
</section>
</section>
<section id="rma-validation">
<h2>7. <strong>RMA Validation</strong><a class="headerlink" href="#rma-validation" title="Link to this heading">¶</a></h2>
<section id="id11">
<h3><strong>Summary</strong><a class="headerlink" href="#id11" title="Link to this heading">¶</a></h3>
<p>This function checks whether a Return Merchandise Authorization (RMA) record exists for a given invoice. It ensures that returns are properly authorized before processing.</p>
</section>
<section id="id12">
<h3><strong>T-SQL Function</strong><a class="headerlink" href="#id12" title="Link to this heading">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">validate_rma</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">BIT</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="nb">BIT</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Ensure the RMA record exists for the invoice and is approved</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARINVL</span><span class="w"> </span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKAR_INV_INVNO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span>
<span class="w">          </span><span class="k">AND</span><span class="w"> </span><span class="n">BKAR_INV_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;RMA&#39;</span>
<span class="w">          </span><span class="k">AND</span><span class="w"> </span><span class="n">BKAR_INV_RMA_STATUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Approved&#39;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">-- RMA found and approved</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- RMA not found or not approved</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="o">@</span><span class="k">result</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="k">GO</span>
</pre></div>
</div>
</section>
</section>
</section>

</main>
                        <nav aria-label="Page navigation" class="py-4 my-5 clearfix font-weight-bold border-top">
    <a class="float-left" href="post_so.html" title="Previous">
        <span aria-hidden="true">←&nbsp;</span><code class="docutils literal notranslate"><span class="pre">post_so</span></code> Stored Procedure Documentation
    </a>
    <a class="float-right" href="markpoint-1.html" title="Next">
        Markpoint 1 AND 2: Save to Accounts Receivable Payment Record <span aria-hidden="true">&nbsp;→</span>
    </a>
</nav>
                    </div>
                    
                    <nav class="col-12 col-lg-3 pb-4">
                        <div class="sticky-top toc page-toc" aria-labelledby="page-toc-heading">
                            <p class="font-weight-bold" id="page-toc-heading">Page contents</p>
                            <ul>
<li><a class="reference internal" href="#">Pre-validation SQL Procedures</a><ul>
<li><a class="reference internal" href="#check-invoice-status">1. <strong>Check Invoice Status</strong></a><ul>
<li><a class="reference internal" href="#summary"><strong>Summary</strong></a></li>
<li><a class="reference internal" href="#t-sql-function"><strong>T-SQL Function</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#customer-record-validation">2. <strong>Customer Record Validation</strong></a><ul>
<li><a class="reference internal" href="#id1"><strong>Summary</strong></a></li>
<li><a class="reference internal" href="#id2"><strong>T-SQL Function</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#inventory-validation">3. <strong>Inventory Validation</strong></a><ul>
<li><a class="reference internal" href="#id3"><strong>Summary</strong></a></li>
<li><a class="reference internal" href="#id4"><strong>T-SQL Function</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#tax-validation">4. <strong>Tax Validation</strong></a><ul>
<li><a class="reference internal" href="#id5"><strong>Summary</strong></a></li>
<li><a class="reference internal" href="#id6"><strong>T-SQL Function</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#payment-terms-validation">5. <strong>Payment Terms Validation</strong></a><ul>
<li><a class="reference internal" href="#id7"><strong>Summary</strong></a></li>
<li><a class="reference internal" href="#id8"><strong>T-SQL Function</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#salesperson-record-validation">6. <strong>Salesperson Record Validation</strong></a><ul>
<li><a class="reference internal" href="#id9"><strong>Summary</strong></a></li>
<li><a class="reference internal" href="#id10"><strong>T-SQL Function</strong></a></li>
</ul>
</li>
<li><a class="reference internal" href="#rma-validation">7. <strong>RMA Validation</strong></a><ul>
<li><a class="reference internal" href="#id11"><strong>Summary</strong></a></li>
<li><a class="reference internal" href="#id12"><strong>T-SQL Function</strong></a></li>
</ul>
</li>
</ul>
</li>
</ul>

                        </div>
                    </nav>
                    
                </div>
            </div>
        </div>
    </div>
    <footer class="container-fluid bg-primary text-light">
        <div class="container">
            <div class="row">
        <div class="col p-4">
            
                <nav aria-label="Footer">
                    <ul class="nav justify-content-center mb-2">
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/features/">Features</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/about-wagtail/"> About Wagtail</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/services/"> Services</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/blog/"> Blog</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/packages/"> Packages</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/developers/"> Developers</a></li>
                        
                    </ul>
                </nav>
            
            <div class="text-center">
                <p style="display: none">
                    <a class="text-light" href="https://github.com/wagtail/sphinx_wagtail_theme" rel="nofollow" target="_blank">
                        Wagtail Sphinx Theme 6.3.0
                    </a>
                </p>
            </div>
            <div class="text-center">
                    &copy; Copyright 2024, Chris Watkins
            </div>
        </div>
    </div>
        </div>
    </footer>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script type="text/javascript" src="_static/dist/theme.js"></script>
        <script type="text/javascript" src="_static/dist/vendor.js"></script>
        <script type="text/javascript" src="_static/searchtools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() { Search.loadIndex("searchindex.js"); });
        </script>
        <script type="text/javascript" id="searchindexloader"></script>
    </body>
</html>