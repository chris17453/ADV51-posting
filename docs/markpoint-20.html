<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
        <title>Markpoint 20, 21, 22: Update Tax Authority and Process Tax Amounts &mdash; TAS Posting  documentation</title>
    
    <link rel="stylesheet" type="text/css" href="_static/dist/fontawesome.css" />
      <link rel="stylesheet" type="text/css" href="_static/dist/theme.css?v=ea6a6c20" />
            <link rel="index" title="Index" href="genindex.html" />
            <link rel="search" title="Search" href="search.html" />
            <link rel="top" title="TAS Posting  documentation" href="#" />
            <link rel="next" title="Markpoint 23: Delete Invoice Sales Lines" href="markpoint-23.html" />
            <link rel="prev" title="Markpoint 19: Update Customer Points" href="markpoint-19.html" />
    </head>
<body>
    <script type="text/javascript" src="_static/dist/blocking.js"></script>
    <header class="container-fluid bg-primary">
        <a class="btn btn-sm btn-light skip-to-content-link" href="#main">Skip to content</a>
        <div class="container-fluid">
            <div class="navbar navbar-expand-lg navbar-dark font-weight-bold">
                    <a href="index.html"
                        title="Wagtail"
                        class="logo navbar-brand"
                    >
                        <img src="_static/img/wagtail-logo-new.svg" width="45" height="59" alt="Wagtail"
                            class="logo-img"
                        />
                        ADV 5.1 Posting Migration
                    </a>
                
                
                <button class="navbar-toggler btn btn-primary d-lg-none" type="button" data-toggle="collapse" data-target="#collapseSidebar" aria-expanded="false" aria-controls="collapseExample">
                    <span class="navbar-toggler-icon"></span>
                    <span class="sr-only">menu</span>
                </button>
            </div>
        </div>
    </header>
    <div class="container-fluid">
        <div class="row">
            <aside class="col-12 col-lg-3 sidebar-container">
                <div id="collapseSidebar" class="collapse sticky-top d-lg-block pt-5 pr-lg-4">
<div id="searchbox" class="searchbox mb-6 px-1" role="search">
    <form id="search-form" action="search.html" autocomplete="off" method="get" role="search">
        <div class="input-group">
            <div class="input-group-prepend">
                <div class="input-group-text border-right-0 bg-white py-3 pl-3 pr-2"><span class="fas fa-search"></span></div>
            </div>
            <input class="form-control py-3 pr-3 pl-1 h-100 border-left-0" type="search" name="q" placeholder="Search documentation" aria-label="Search documentation" id="searchinput" />
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div><div class="site-toc">
    <nav class="toc mt-3" aria-label="Main menu">
        <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="post_so.html">Post_SO</a></li>
<li class="toctree-l1"><a class="reference internal" href="pre-valiation.html">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-1.html">Mark Point 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-3.html">Mark Point 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-4.html">Mark Point 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-5.html">Mark Point 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-6.html">Mark Point 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-7.html">Mark Point 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-8.html">Mark Point 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-9.html">Mark Point 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-10.html">Mark Point 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-11.html">Mark Point 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-12.html">Mark Point 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-13.html">Mark Point 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-14.html">Mark Point 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-15.html">Mark Point 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-16.html">Mark Point 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-17.html">Mark Point 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-18.html">Mark Point 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-19.html">Mark Point 19</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Mark Point 20</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-23.html">Mark Point 23</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-24.html">Mark Point 24</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-25.html">Mark Point 25</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-26.html">Mark Point 26</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="post_to_gl2.html">post_to_gl2</a></li>
<li class="toctree-l1"><a class="reference internal" href="all_tables.html">All Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint.html">Markpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="errorlog.html">ErrorLog</a></li>
</ul>

    </nav>
    <template data-toggle-item-template>
        <button class="btn btn-sm btn-link toctree-expand" type="button">
            <span class="sr-only">Toggle menu contents</span>
        </button>
    </template>
</div>
                    <div class="d-lg-none border-bottom">
                        
                    </div>
                </div>
            </aside>
            <div class="col-12 col-lg-9 pt-5">
                <header class="row align-items-baseline">
                    <div class="col">
                        <nav aria-label="breadcrumb">
    <ol class="breadcrumb m-0 p-0 bg-transparent">
        <li class="breadcrumb-item"><a href="index.html">Docs</a></li>
        <li class="breadcrumb-item active" aria-current="page">Markpoint 20, 21, 22: Update Tax Authority and Process Tax Amounts</li>
    </ol>
</nav>
                    </div>
                    <div class="col-sm-12 col-lg-auto mt-3 mt-lg-3">
                        <noscript>
                            <p>JavaScript is required to toggle light/dark mode..</p>
                        </noscript>
                        <button id="wagtail-theme" class="btn btn-sm btn-light text-decoration-none" type="button">
                            <span class="dark-only"><i class="fas fa-sun"></i> Light mode</span>
                            <span class="light-only"><i class="fas fa-moon"></i> Dark mode</span>
                        </button>
    <a class="btn btn-sm btn-light text-decoration-none" href="https://github.com/wagtail/sphinx_wagtail_theme/blob/main/docs/markpoint-20.md" rel="nofollow">
        <span class="btn-icon"><span class="fab fa-github"></span></span>
        <span class="btn-text">Edit on GitHub</span>
    </a>
    <a class="btn btn-sm btn-light text-decoration-none" href="_sources/markpoint-20.md.txt" rel="nofollow">
        <span class="btn-icon"><span class="fas fa-code"></span></span>
        <span class="btn-text">View source</span>
    </a>
                        
                    </div>
                </header>
                <div class="row" >
                    <div class="col-12">
                        <hr class="w-100 my-4">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-lg-9 order-last order-lg-first rst-content">
                        <main role="main" id="main">
    <section id="markpoint-20-21-22-update-tax-authority-and-process-tax-amounts">
<h1>Markpoint 20, 21, 22: Update Tax Authority and Process Tax Amounts<a class="headerlink" href="#markpoint-20-21-22-update-tax-authority-and-process-tax-amounts" title="Link to this heading">¶</a></h1>
<section id="summary">
<h2>Summary:<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>This function updates the tax authority records for an invoice and processes the tax amounts for each tax authority based on the invoice details. It handles multiple mark points (20, 21, and 22) using the <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> function to ensure correct posting to the general ledger (GL) and updates to tax records. The function performs tax calculations based on the invoice taxable and non-taxable amounts and posts to the appropriate GL accounts.</p>
</section>
<section id="mssql-function">
<h2>MSSQL Function<a class="headerlink" href="#mssql-function" title="Link to this heading">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">Markpoint22_UpdateTaxAuthority</span>
<span class="w">    </span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="c1">-- Declare variables</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">is_taxable</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_rate1</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_rate2</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">freight_amount</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">temp_tax_amt1</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">temp_tax_amt2</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">temp_tot_tax</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt3</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">tot_taxable</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tot_nontaxable</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="k">month</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">tax_key</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span><span class="w"> </span><span class="o">@</span><span class="n">vendor</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span><span class="w"> </span><span class="o">@</span><span class="n">tax_frght</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">-- Retrieve the invoice details</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">is_taxable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_TAXABL</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_TAXAMT</span><span class="p">,</span><span class="w"> </span>
<span class="w">           </span><span class="o">@</span><span class="n">tax_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_TAXKEY</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">freight_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_FRGHT</span><span class="p">,</span><span class="w"> </span>
<span class="w">           </span><span class="o">@</span><span class="n">tax_rate1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_TAXRTE</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKAR_INV</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKAR_INV_INVNUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoice_number</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- If the mark point is already set to 22, return</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">MARK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span>
<span class="w">        </span><span class="k">RETURN</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- If the invoice is not taxable and the tax amount is 0, return</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">is_taxable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;N&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">RETURN</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Fetch the tax authority record based on the tax key</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKICTAX</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKIC_TAX_AUTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_key</span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="c1">-- Set the month value based on the invoice date</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">month</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">MONTH</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">());</span>

<span class="w">        </span><span class="c1">-- Calculate the taxable amount including freight if applicable</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKICTAX</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKIC_TAX_FRGHT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">BKIC_TAX_AUTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_key</span><span class="p">)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tot_taxable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tot_taxable</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">freight_amount</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- Update taxable and non-taxable amounts</span>
<span class="w">        </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">BKICTAX</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">BKIC_TAX_TAXBLE</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_TAXBLE</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tot_taxable</span><span class="p">,</span>
<span class="w">            </span><span class="n">BKIC_TAX_NONTAX</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_NONTAX</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tot_nontaxable</span><span class="p">,</span>
<span class="w">            </span><span class="n">BKIC_TAX_OUTSTD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_OUTSTD</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKIC_TAX_AUTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_key</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- Calculate tax amounts based on the rates</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">tax_rate1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_RATE1</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="p">;</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>
<span class="w">        </span><span class="k">ELSE</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="c1">-- Custom tax calculation logic for different tax rates</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">tot_taxable</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BKIC_TAX_RATE1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">tot_taxable</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BKIC_TAX_RATE2</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- Reconcile the calculated total tax with the invoice tax amount</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">temp_tot_tax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt3</span><span class="p">;</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">temp_tot_tax</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">tax_amount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">temp_tot_tax</span><span class="p">);</span>

<span class="w">        </span><span class="c1">-- Update the tax collection amounts for the month</span>
<span class="w">        </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">BKICTAX</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">BKIC_TAX_COLECT</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_COLECT</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="p">,</span>
<span class="w">            </span><span class="n">BKIC_TAX_COLEC2</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_COLEC2</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="p">,</span>
<span class="w">            </span><span class="n">BKIC_TAX_OUTST1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_OUTST1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="p">,</span>
<span class="w">            </span><span class="n">BKIC_TAX_OUTST2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_OUTST2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKIC_TAX_AUTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_key</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- Post to general ledger (GL) if tax amount 1 is not zero and mark point 20 has not been completed</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">MARK</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">False</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">post_to_gl2</span><span class="w"> </span><span class="n">BKIC_TAX_GLACT</span><span class="p">,</span><span class="w"> </span><span class="n">BKIC_TAX_GLDPT</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#1-Sls Tx Inv &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">vendor</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- Handle post failure</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="o">@@</span><span class="n">ERROR</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="k">BEGIN</span>
<span class="w">                </span><span class="k">EXEC</span><span class="w"> </span><span class="n">clr</span><span class="w"> </span><span class="o">@</span><span class="n">BKICTAX_HNDL</span><span class="p">;</span>
<span class="w">                </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">            </span><span class="k">END</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">True</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- Post tax amount 2 to GL if applicable and mark point 21 is not completed</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">MARK</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">21</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">False</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">post_to_gl2</span><span class="w"> </span><span class="n">BKIC_TAX_GLACT2</span><span class="p">,</span><span class="w"> </span><span class="n">BKIC_TAX_GLDPT2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#2-Sls Tx Inv &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">vendor</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- Handle post failure</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="o">@@</span><span class="n">ERROR</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="k">BEGIN</span>
<span class="w">                </span><span class="k">EXEC</span><span class="w"> </span><span class="n">clr</span><span class="w"> </span><span class="o">@</span><span class="n">BKICTAX_HNDL</span><span class="p">;</span>
<span class="w">                </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">            </span><span class="k">END</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">True</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="c1">-- Handle missing tax authority record</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">MARK</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="c1">-- Post default tax to GL</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">False</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">post_to_gl2</span><span class="w"> </span><span class="n">BKSY_TAX_GLACT</span><span class="p">,</span><span class="w"> </span><span class="n">BKSY_TAX_GLDPT</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sls Tx Inv - System Dflt&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- Handle post failure</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="o">@@</span><span class="n">ERROR</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="k">BEGIN</span>
<span class="w">                </span><span class="k">EXEC</span><span class="w"> </span><span class="n">clr</span><span class="w"> </span><span class="o">@</span><span class="n">BKICTAX_HNDL</span><span class="p">;</span>
<span class="w">                </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">            </span><span class="k">END</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">True</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="c1">-- Save changes to BKICTAX</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="o">@@</span><span class="n">ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">False</span><span class="p">;</span>
<span class="w">        </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">BKICTAX</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">BKIC_TAX_OUTSTD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_OUTSTD</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="p">;</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">True</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="c1">-- Final cleanup and post-status handling</span>
<span class="w">    </span><span class="k">EXEC</span><span class="w"> </span><span class="n">post_status</span><span class="p">;</span>

<span class="k">END</span>
<span class="k">GO</span>
</pre></div>
</div>
<section id="breakdown-of-tasks">
<h3>Breakdown of Tasks:<a class="headerlink" href="#breakdown-of-tasks" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Set Markpoint 22 (Start):</strong></p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> function is used to indicate the beginning of tax authority updates at mark point 22.</p></li>
</ul>
</li>
<li><p><strong>Update Tax Authority:</strong></p>
<ul class="simple">
<li><p>The function checks if the invoice is taxable. If it is, the tax amounts are calculated and posted to the tax authority’s record (<code class="docutils literal notranslate"><span class="pre">BKICTAX</span></code>), updating taxable, non-taxable, and outstanding amounts.</p></li>
</ul>
</li>
<li><p><strong>Post to General Ledger (GL) for Tax Amounts (Markpoint 20 and 21):</strong></p>
<ul class="simple">
<li><p>If the tax amount is not zero, mark point 20 is set, and the tax is posted to the appropriate GL accounts (<code class="docutils literal notranslate"><span class="pre">BKIC_TAX_GLACT</span></code> for tax amount 1 and <code class="docutils literal notranslate"><span class="pre">BKIC_TAX_GLACT2</span></code> for tax amount 2). The function checks if mark point 21 has already been set before posting tax amount 2.</p></li>
</ul>
</li>
<li><p><strong>Complete Markpoint 22 (End):</strong></p>
<ul class="simple">
<li><p>Once the tax authority updates are successful, mark point 22 is completed using the <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> function.</p></li>
</ul>
</li>
<li><p><strong>Handle Missing Tax Authority Record:</strong></p>
<ul class="simple">
<li><p>If the tax authority record does not exist, a default system posting is performed for the tax amounts, and mark point 20 is set.</p></li>
</ul>
</li>
</ol>
</section>
<section id="error-handling">
<h3>Error Handling:<a class="headerlink" href="#error-handling" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>The function uses <code class="docutils literal notranslate"><span class="pre">TRY...CATCH</span></code> blocks to handle errors during the posting to GL or updating the tax authority records. Any failure during these processes will result in appropriate cleanup and rollback.</p></li>
</ul>
</section>
<section id="testing">
<h3>Testing:<a class="headerlink" href="#testing" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Test Case 1: Standard Taxable Invoice</strong></p>
<ul>
<li><p>Run the function with a standard taxable invoice and verify that all tax amounts are processed correctly and posted to the appropriate GL accounts.</p></li>
</ul>
</li>
<li><p><strong>Test Case 2: Non-Taxable Invoice</strong></p>
<ul>
<li><p>Run the function with a non-taxable invoice and ensure that no tax amounts are processed, and the function completes without errors.</p></li>
</ul>
</li>
<li><p><strong>Test Case 3: Missing Tax Authority Record</strong></p>
<ul>
<li><p>Run the function with an invoice that has no associated tax authority record and ensure that the default system posting is performed.</p></li>
</ul>
</li>
</ul>
</section>
<section id="notes">
<h3>Notes:<a class="headerlink" href="#notes" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Mark Points:</strong> Mark points 20, 21, and 22 are used to control the flow of posting to the GL accounts and ensure that each part of the process completes successfully before moving to the next.</p></li>
<li><p><strong>Performance Considerations:</strong> Test the function with large datasets to ensure that the tax calculation and posting processes do not significantly impact system performance.</p></li>
</ul>
</section>
</section>
</section>

</main>
                        <nav aria-label="Page navigation" class="py-4 my-5 clearfix font-weight-bold border-top">
    <a class="float-left" href="markpoint-19.html" title="Previous">
        <span aria-hidden="true">←&nbsp;</span>Markpoint 19: Update Customer Points
    </a>
    <a class="float-right" href="markpoint-23.html" title="Next">
        Markpoint 23: Delete Invoice Sales Lines <span aria-hidden="true">&nbsp;→</span>
    </a>
</nav>
                    </div>
                    
                    <nav class="col-12 col-lg-3 pb-4">
                        <div class="sticky-top toc page-toc" aria-labelledby="page-toc-heading">
                            <p class="font-weight-bold" id="page-toc-heading">Page contents</p>
                            <ul>
<li><a class="reference internal" href="#">Markpoint 20, 21, 22: Update Tax Authority and Process Tax Amounts</a><ul>
<li><a class="reference internal" href="#summary">Summary:</a></li>
<li><a class="reference internal" href="#mssql-function">MSSQL Function</a><ul>
<li><a class="reference internal" href="#breakdown-of-tasks">Breakdown of Tasks:</a></li>
<li><a class="reference internal" href="#error-handling">Error Handling:</a></li>
<li><a class="reference internal" href="#testing">Testing:</a></li>
<li><a class="reference internal" href="#notes">Notes:</a></li>
</ul>
</li>
</ul>
</li>
</ul>

                        </div>
                    </nav>
                    
                </div>
            </div>
        </div>
    </div>
    <footer class="container-fluid bg-primary text-light">
        <div class="container">
            <div class="row">
        <div class="col p-4">
            
                <nav aria-label="Footer">
                    <ul class="nav justify-content-center mb-2">
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/features/">Features</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/about-wagtail/"> About Wagtail</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/services/"> Services</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/blog/"> Blog</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/packages/"> Packages</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/developers/"> Developers</a></li>
                        
                    </ul>
                </nav>
            
            <div class="text-center">
                <p style="display: none">
                    <a class="text-light" href="https://github.com/wagtail/sphinx_wagtail_theme" rel="nofollow" target="_blank">
                        Wagtail Sphinx Theme 6.3.0
                    </a>
                </p>
            </div>
            <div class="text-center">
                    &copy; Copyright 2024, Chris Watkins
            </div>
        </div>
    </div>
        </div>
    </footer>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script type="text/javascript" src="_static/dist/theme.js"></script>
        <script type="text/javascript" src="_static/dist/vendor.js"></script>
        <script type="text/javascript" src="_static/searchtools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() { Search.loadIndex("searchindex.js"); });
        </script>
        <script type="text/javascript" id="searchindexloader"></script>
    </body>
</html>