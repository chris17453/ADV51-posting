<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Markpoint 20, 21, 22: Update Tax Authority and Process Tax Amounts &mdash; TAS Posting  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Markpoint 23: Delete Invoice Sales Lines" href="markpoint-23.html" />
    <link rel="prev" title="Markpoint 19: Update Customer Points" href="markpoint-19.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            TAS Posting
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="post_so.html">Post_SO</a></li>
<li class="toctree-l1"><a class="reference internal" href="pre-valiation.html">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-1.html">Mark Point 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-3.html">Mark Point 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-4.html">Mark Point 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-5.html">Mark Point 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-6.html">Mark Point 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-7.html">Mark Point 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-8.html">Mark Point 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-9.html">Mark Point 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-10.html">Mark Point 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-11.html">Mark Point 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-12.html">Mark Point 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-13.html">Mark Point 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-14.html">Mark Point 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-15.html">Mark Point 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-16.html">Mark Point 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-17.html">Mark Point 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-18.html">Mark Point 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-19.html">Mark Point 19</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Mark Point 20</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-23.html">Mark Point 23</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-24.html">Mark Point 24</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-25.html">Mark Point 25</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-26.html">Mark Point 26</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="post_to_gl2.html">POST_TO_GL2 post_to_gl2</a></li>
<li class="toctree-l1"><a class="reference internal" href="all_tables.html">All Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint.html">Markpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="errorlog.html">ErrorLog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">TAS Posting</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Markpoint 20, 21, 22: Update Tax Authority and Process Tax Amounts</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/markpoint-20.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="markpoint-20-21-22-update-tax-authority-and-process-tax-amounts">
<h1>Markpoint 20, 21, 22: Update Tax Authority and Process Tax Amounts<a class="headerlink" href="#markpoint-20-21-22-update-tax-authority-and-process-tax-amounts" title="Link to this heading"></a></h1>
<section id="summary">
<h2>Summary:<a class="headerlink" href="#summary" title="Link to this heading"></a></h2>
<p>This function updates the tax authority records for an invoice and processes the tax amounts for each tax authority based on the invoice details. It handles multiple mark points (20, 21, and 22) using the <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> function to ensure correct posting to the general ledger (GL) and updates to tax records. The function performs tax calculations based on the invoice taxable and non-taxable amounts and posts to the appropriate GL accounts.</p>
</section>
<section id="mssql-function">
<h2>MSSQL Function<a class="headerlink" href="#mssql-function" title="Link to this heading"></a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">Markpoint22_UpdateTaxAuthority</span>
<span class="w">    </span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="c1">-- Declare variables</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">is_taxable</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_rate1</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_rate2</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">freight_amount</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">temp_tax_amt1</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">temp_tax_amt2</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">temp_tot_tax</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt3</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">tot_taxable</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tot_nontaxable</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="k">month</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">tax_key</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span><span class="w"> </span><span class="o">@</span><span class="n">vendor</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span><span class="w"> </span><span class="o">@</span><span class="n">tax_frght</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">-- Retrieve the invoice details</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">is_taxable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_TAXABL</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_TAXAMT</span><span class="p">,</span><span class="w"> </span>
<span class="w">           </span><span class="o">@</span><span class="n">tax_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_TAXKEY</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">freight_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_FRGHT</span><span class="p">,</span><span class="w"> </span>
<span class="w">           </span><span class="o">@</span><span class="n">tax_rate1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_TAXRTE</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKAR_INV</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKAR_INV_INVNUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoice_number</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- If the mark point is already set to 22, return</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">MARK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span>
<span class="w">        </span><span class="k">RETURN</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- If the invoice is not taxable and the tax amount is 0, return</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">is_taxable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;N&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">RETURN</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Fetch the tax authority record based on the tax key</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKICTAX</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKIC_TAX_AUTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_key</span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="c1">-- Set the month value based on the invoice date</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">month</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">MONTH</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">());</span>

<span class="w">        </span><span class="c1">-- Calculate the taxable amount including freight if applicable</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKICTAX</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKIC_TAX_FRGHT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">BKIC_TAX_AUTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_key</span><span class="p">)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tot_taxable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tot_taxable</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">freight_amount</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- Update taxable and non-taxable amounts</span>
<span class="w">        </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">BKICTAX</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">BKIC_TAX_TAXBLE</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_TAXBLE</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tot_taxable</span><span class="p">,</span>
<span class="w">            </span><span class="n">BKIC_TAX_NONTAX</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_NONTAX</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tot_nontaxable</span><span class="p">,</span>
<span class="w">            </span><span class="n">BKIC_TAX_OUTSTD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_OUTSTD</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKIC_TAX_AUTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_key</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- Calculate tax amounts based on the rates</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">tax_rate1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_RATE1</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="p">;</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>
<span class="w">        </span><span class="k">ELSE</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="c1">-- Custom tax calculation logic for different tax rates</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">tot_taxable</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BKIC_TAX_RATE1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">tot_taxable</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BKIC_TAX_RATE2</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- Reconcile the calculated total tax with the invoice tax amount</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">temp_tot_tax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt3</span><span class="p">;</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">temp_tot_tax</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">tax_amount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">temp_tot_tax</span><span class="p">);</span>

<span class="w">        </span><span class="c1">-- Update the tax collection amounts for the month</span>
<span class="w">        </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">BKICTAX</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">BKIC_TAX_COLECT</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_COLECT</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="p">,</span>
<span class="w">            </span><span class="n">BKIC_TAX_COLEC2</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_COLEC2</span><span class="p">[</span><span class="o">@</span><span class="k">month</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="p">,</span>
<span class="w">            </span><span class="n">BKIC_TAX_OUTST1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_OUTST1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="p">,</span>
<span class="w">            </span><span class="n">BKIC_TAX_OUTST2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_OUTST2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKIC_TAX_AUTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tax_key</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- Post to general ledger (GL) if tax amount 1 is not zero and mark point 20 has not been completed</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">MARK</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">False</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">post_to_gl2</span><span class="w"> </span><span class="n">BKIC_TAX_GLACT</span><span class="p">,</span><span class="w"> </span><span class="n">BKIC_TAX_GLDPT</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#1-Sls Tx Inv &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">vendor</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt1</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- Handle post failure</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="o">@@</span><span class="n">ERROR</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="k">BEGIN</span>
<span class="w">                </span><span class="k">EXEC</span><span class="w"> </span><span class="n">clr</span><span class="w"> </span><span class="o">@</span><span class="n">BKICTAX_HNDL</span><span class="p">;</span>
<span class="w">                </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">            </span><span class="k">END</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">True</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- Post tax amount 2 to GL if applicable and mark point 21 is not completed</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">MARK</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">21</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">False</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">post_to_gl2</span><span class="w"> </span><span class="n">BKIC_TAX_GLACT2</span><span class="p">,</span><span class="w"> </span><span class="n">BKIC_TAX_GLDPT2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#2-Sls Tx Inv &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">vendor</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amt2</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- Handle post failure</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="o">@@</span><span class="n">ERROR</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="k">BEGIN</span>
<span class="w">                </span><span class="k">EXEC</span><span class="w"> </span><span class="n">clr</span><span class="w"> </span><span class="o">@</span><span class="n">BKICTAX_HNDL</span><span class="p">;</span>
<span class="w">                </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">            </span><span class="k">END</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">True</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="c1">-- Handle missing tax authority record</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">MARK</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="c1">-- Post default tax to GL</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">False</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">post_to_gl2</span><span class="w"> </span><span class="n">BKSY_TAX_GLACT</span><span class="p">,</span><span class="w"> </span><span class="n">BKSY_TAX_GLDPT</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sls Tx Inv - System Dflt&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- Handle post failure</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="o">@@</span><span class="n">ERROR</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="k">BEGIN</span>
<span class="w">                </span><span class="k">EXEC</span><span class="w"> </span><span class="n">clr</span><span class="w"> </span><span class="o">@</span><span class="n">BKICTAX_HNDL</span><span class="p">;</span>
<span class="w">                </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">            </span><span class="k">END</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">True</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="c1">-- Save changes to BKICTAX</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="o">@@</span><span class="n">ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">False</span><span class="p">;</span>
<span class="w">        </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">BKICTAX</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">BKIC_TAX_OUTSTD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKIC_TAX_OUTSTD</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">tax_amount</span><span class="p">;</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">mark_point</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">True</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="c1">-- Final cleanup and post-status handling</span>
<span class="w">    </span><span class="k">EXEC</span><span class="w"> </span><span class="n">post_status</span><span class="p">;</span>

<span class="k">END</span>
<span class="k">GO</span>
</pre></div>
</div>
<section id="breakdown-of-tasks">
<h3>Breakdown of Tasks:<a class="headerlink" href="#breakdown-of-tasks" title="Link to this heading"></a></h3>
<ol class="arabic simple">
<li><p><strong>Set Markpoint 22 (Start):</strong></p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> function is used to indicate the beginning of tax authority updates at mark point 22.</p></li>
</ul>
</li>
<li><p><strong>Update Tax Authority:</strong></p>
<ul class="simple">
<li><p>The function checks if the invoice is taxable. If it is, the tax amounts are calculated and posted to the tax authority’s record (<code class="docutils literal notranslate"><span class="pre">BKICTAX</span></code>), updating taxable, non-taxable, and outstanding amounts.</p></li>
</ul>
</li>
<li><p><strong>Post to General Ledger (GL) for Tax Amounts (Markpoint 20 and 21):</strong></p>
<ul class="simple">
<li><p>If the tax amount is not zero, mark point 20 is set, and the tax is posted to the appropriate GL accounts (<code class="docutils literal notranslate"><span class="pre">BKIC_TAX_GLACT</span></code> for tax amount 1 and <code class="docutils literal notranslate"><span class="pre">BKIC_TAX_GLACT2</span></code> for tax amount 2). The function checks if mark point 21 has already been set before posting tax amount 2.</p></li>
</ul>
</li>
<li><p><strong>Complete Markpoint 22 (End):</strong></p>
<ul class="simple">
<li><p>Once the tax authority updates are successful, mark point 22 is completed using the <code class="docutils literal notranslate"><span class="pre">mark_point</span></code> function.</p></li>
</ul>
</li>
<li><p><strong>Handle Missing Tax Authority Record:</strong></p>
<ul class="simple">
<li><p>If the tax authority record does not exist, a default system posting is performed for the tax amounts, and mark point 20 is set.</p></li>
</ul>
</li>
</ol>
</section>
<section id="error-handling">
<h3>Error Handling:<a class="headerlink" href="#error-handling" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>The function uses <code class="docutils literal notranslate"><span class="pre">TRY...CATCH</span></code> blocks to handle errors during the posting to GL or updating the tax authority records. Any failure during these processes will result in appropriate cleanup and rollback.</p></li>
</ul>
</section>
<section id="testing">
<h3>Testing:<a class="headerlink" href="#testing" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>Test Case 1: Standard Taxable Invoice</strong></p>
<ul>
<li><p>Run the function with a standard taxable invoice and verify that all tax amounts are processed correctly and posted to the appropriate GL accounts.</p></li>
</ul>
</li>
<li><p><strong>Test Case 2: Non-Taxable Invoice</strong></p>
<ul>
<li><p>Run the function with a non-taxable invoice and ensure that no tax amounts are processed, and the function completes without errors.</p></li>
</ul>
</li>
<li><p><strong>Test Case 3: Missing Tax Authority Record</strong></p>
<ul>
<li><p>Run the function with an invoice that has no associated tax authority record and ensure that the default system posting is performed.</p></li>
</ul>
</li>
</ul>
</section>
<section id="notes">
<h3>Notes:<a class="headerlink" href="#notes" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>Mark Points:</strong> Mark points 20, 21, and 22 are used to control the flow of posting to the GL accounts and ensure that each part of the process completes successfully before moving to the next.</p></li>
<li><p><strong>Performance Considerations:</strong> Test the function with large datasets to ensure that the tax calculation and posting processes do not significantly impact system performance.</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="markpoint-19.html" class="btn btn-neutral float-left" title="Markpoint 19: Update Customer Points" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="markpoint-23.html" class="btn btn-neutral float-right" title="Markpoint 23: Delete Invoice Sales Lines" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Chris Watkins.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>