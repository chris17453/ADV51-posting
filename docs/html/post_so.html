<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
        <title>post_so Stored Procedure Documentation &mdash; TAS Posting  documentation</title>
    
    <link rel="stylesheet" type="text/css" href="_static/dist/fontawesome.css" />
      <link rel="stylesheet" type="text/css" href="_static/dist/theme.css?v=ea6a6c20" />
            <link rel="index" title="Index" href="genindex.html" />
            <link rel="search" title="Search" href="search.html" />
            <link rel="top" title="TAS Posting  documentation" href="#" />
            <link rel="next" title="Pre-validation SQL Procedures" href="pre-valiation.html" />
            <link rel="prev" title="TAS Posting documentation" href="index.html" />
    </head>
<body>
    <script type="text/javascript" src="_static/dist/blocking.js"></script>
    <header class="container-fluid bg-primary">
        <a class="btn btn-sm btn-light skip-to-content-link" href="#main">Skip to content</a>
        <div class="container-fluid">
            <div class="navbar navbar-expand-lg navbar-dark font-weight-bold">
                    <a href="index.html"
                        title="Wagtail"
                        class="logo navbar-brand"
                    >
                        <img src="_static/img/wagtail-logo-new.svg" width="45" height="59" alt="Wagtail"
                            class="logo-img"
                        />
                        ADV 5.1 Posting Migration
                    </a>
                
                
                <button class="navbar-toggler btn btn-primary d-lg-none" type="button" data-toggle="collapse" data-target="#collapseSidebar" aria-expanded="false" aria-controls="collapseExample">
                    <span class="navbar-toggler-icon"></span>
                    <span class="sr-only">menu</span>
                </button>
            </div>
        </div>
    </header>
    <div class="container-fluid">
        <div class="row">
            <aside class="col-12 col-lg-3 sidebar-container">
                <div id="collapseSidebar" class="collapse sticky-top d-lg-block pt-5 pr-lg-4">
<div id="searchbox" class="searchbox mb-6 px-1" role="search">
    <form id="search-form" action="search.html" autocomplete="off" method="get" role="search">
        <div class="input-group">
            <div class="input-group-prepend">
                <div class="input-group-text border-right-0 bg-white py-3 pl-3 pr-2"><span class="fas fa-search"></span></div>
            </div>
            <input class="form-control py-3 pr-3 pl-1 h-100 border-left-0" type="search" name="q" placeholder="Search documentation" aria-label="Search documentation" id="searchinput" />
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div><div class="site-toc">
    <nav class="toc mt-3" aria-label="Main menu">
        <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Post_SO</a></li>
<li class="toctree-l1"><a class="reference internal" href="pre-valiation.html">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-1.html">Mark Point 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-3.html">Mark Point 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-4.html">Mark Point 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-5.html">Mark Point 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-6.html">Mark Point 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-7.html">Mark Point 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-8.html">Mark Point 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-9.html">Mark Point 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-10.html">Mark Point 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-11.html">Mark Point 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-12.html">Mark Point 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-13.html">Mark Point 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-14.html">Mark Point 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-15.html">Mark Point 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-16.html">Mark Point 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-17.html">Mark Point 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-18.html">Mark Point 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-19.html">Mark Point 19</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-20.html">Mark Point 20</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-23.html">Mark Point 23</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-24.html">Mark Point 24</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-25.html">Mark Point 25</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-26.html">Mark Point 26</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="post_to_gl2.html">post_to_gl2</a></li>
<li class="toctree-l1"><a class="reference internal" href="all_tables.html">All Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint.html">Markpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="errorlog.html">ErrorLog</a></li>
</ul>

    </nav>
    <template data-toggle-item-template>
        <button class="btn btn-sm btn-link toctree-expand" type="button">
            <span class="sr-only">Toggle menu contents</span>
        </button>
    </template>
</div>
                    <div class="d-lg-none border-bottom">
                        
                    </div>
                </div>
            </aside>
            <div class="col-12 col-lg-9 pt-5">
                <header class="row align-items-baseline">
                    <div class="col">
                        <nav aria-label="breadcrumb">
    <ol class="breadcrumb m-0 p-0 bg-transparent">
        <li class="breadcrumb-item"><a href="index.html">Docs</a></li>
        <li class="breadcrumb-item active" aria-current="page"><code class="docutils literal notranslate"><span class="pre">post_so</span></code> Stored Procedure Documentation</li>
    </ol>
</nav>
                    </div>
                    <div class="col-sm-12 col-lg-auto mt-3 mt-lg-3">
                        <noscript>
                            <p>JavaScript is required to toggle light/dark mode..</p>
                        </noscript>
                        <button id="wagtail-theme" class="btn btn-sm btn-light text-decoration-none" type="button">
                            <span class="dark-only"><i class="fas fa-sun"></i> Light mode</span>
                            <span class="light-only"><i class="fas fa-moon"></i> Dark mode</span>
                        </button>
    <a class="btn btn-sm btn-light text-decoration-none" href="https://github.com/wagtail/sphinx_wagtail_theme/blob/main/docs/post_so.md" rel="nofollow">
        <span class="btn-icon"><span class="fab fa-github"></span></span>
        <span class="btn-text">Edit on GitHub</span>
    </a>
    <a class="btn btn-sm btn-light text-decoration-none" href="_sources/post_so.md.txt" rel="nofollow">
        <span class="btn-icon"><span class="fas fa-code"></span></span>
        <span class="btn-text">View source</span>
    </a>
                        
                    </div>
                </header>
                <div class="row" >
                    <div class="col-12">
                        <hr class="w-100 my-4">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-lg-9 order-last order-lg-first rst-content">
                        <main role="main" id="main">
    <section id="post-so-stored-procedure-documentation">
<h1><code class="docutils literal notranslate"><span class="pre">post_so</span></code> Stored Procedure Documentation<a class="headerlink" href="#post-so-stored-procedure-documentation" title="Link to this heading">¶</a></h1>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">post_so</span></code> stored procedure is designed to process sales orders by performing a series of validations, logging mark points, handling transactions with enhanced error logging, and updating relevant records across multiple tables. This procedure ensures data integrity and consistency by implementing idempotency checks and comprehensive error handling mechanisms.</p>
</section>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#summary"><span class="xref myst">Summary</span></a></p></li>
<li><p><a class="reference internal" href="#description"><span class="xref myst">Description</span></a></p></li>
<li><p><a class="reference internal" href="#prerequisites"><span class="xref myst">Prerequisites</span></a></p></li>
<li><p><a class="reference internal" href="#parameters"><span class="xref myst">Parameters</span></a></p></li>
<li><p><a class="reference internal" href="#procedure-steps"><span class="xref myst">Procedure Steps</span></a></p>
<ul>
<li><p><a class="reference internal" href="#1-parameter-validation"><span class="xref myst">1. Parameter Validation</span></a></p></li>
<li><p><a class="reference internal" href="#2-transaction-management"><span class="xref myst">2. Transaction Management</span></a></p></li>
<li><p><a class="reference internal" href="#3-idempotency-check"><span class="xref myst">3. Idempotency Check</span></a></p></li>
<li><p><a class="reference internal" href="#4-pre-validation-steps"><span class="xref myst">4. Pre-validation Steps</span></a></p></li>
<li><p><a class="reference internal" href="#5-mark-point-header-routines"><span class="xref myst">5. Mark Point Header Routines</span></a></p></li>
<li><p><a class="reference internal" href="#6-mark-point-per-invoice-line-item-processing"><span class="xref myst">6. Mark Point Per Invoice Line Item Processing</span></a></p></li>
<li><p><a class="reference internal" href="#7-mark-point-post-invoice-level-processing"><span class="xref myst">7. Mark Point Post-Invoice Level Processing</span></a></p></li>
<li><p><a class="reference internal" href="#8-finalization"><span class="xref myst">8. Finalization</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#error-handling"><span class="xref myst">Error Handling</span></a></p></li>
<li><p><a class="reference internal" href="#dependencies"><span class="xref myst">Dependencies</span></a></p></li>
<li><p><a class="reference internal" href="#example-usage"><span class="xref myst">Example Usage</span></a></p></li>
<li><p><a class="reference internal" href="#sql-code"><span class="xref myst">SQL Code</span></a></p></li>
</ul>
</section>
<section id="sql-code">
<h2>SQL Code<a class="headerlink" href="#sql-code" title="Link to this heading">¶</a></h2>
<p>Below is the updated <code class="docutils literal notranslate"><span class="pre">post_so</span></code> stored procedure incorporating the required changes:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- =============================================</span>
<span class="c1">-- Author:        Your Name</span>
<span class="c1">-- Create date:   YYYY-MM-DD</span>
<span class="c1">-- Description:   Process Sales Order and Log Mark Points with Enhanced Error Logging</span>
<span class="c1">-- =============================================</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">post_so</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">@</span><span class="n">invoiceNum</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="w">    </span><span class="o">@</span><span class="n">logonCode</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">NOCOUNT</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>

<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Variable to track the current mark point</span>

<span class="w">    </span><span class="k">BEGIN</span><span class="w"> </span><span class="n">TRYS</span>
<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Parameter Validation</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="c1">-- Validate @invoiceNum (must be a positive integer)</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Invoice number must be a positive integer.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- Validate @logonCode length (assuming max length of 20)</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">LEN</span><span class="p">(</span><span class="o">@</span><span class="n">logonCode</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">20</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Logon code exceeds the maximum allowed length of 20 characters.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Start Transaction with SERIALIZABLE Isolation Level</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="w"> </span><span class="k">ISOLATION</span><span class="w"> </span><span class="k">LEVEL</span><span class="w"> </span><span class="k">SERIALIZABLE</span><span class="p">;</span>
<span class="w">        </span><span class="k">BEGIN</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Idempotency Check: Ensure Invoice is Not Already Processed</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">            </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSOMARK</span><span class="w"> </span>
<span class="w">            </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKSOMARK_INVNM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span>
<span class="w">              </span><span class="k">AND</span><span class="w"> </span><span class="n">BKSOMARK_MARK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="c1">-- Assuming mark point 26 signifies completion</span>
<span class="w">              </span><span class="k">AND</span><span class="w"> </span><span class="n">BKSOMARK_DONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Invoice has already been processed.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Pre-validation Steps</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="c1">-- 1. Check Invoice Status</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">check_invoice_status</span><span class="p">(</span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Invoice status is invalid for processing.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- 2. Retrieve and Validate Customer</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">customer_code</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">customer_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_CUSTCODE</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARINV</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKAR_INV_NUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">customer_code</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Customer code not found for the invoice.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">validate_customer</span><span class="p">(</span><span class="o">@</span><span class="n">customer_code</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Customer is either on hold or has exceeded the credit limit.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- 3. Validate Inventory</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">validate_inventory</span><span class="p">(</span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;One or more inventory items do not exist or have insufficient stock.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- 4. Validate Tax</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">validate_tax</span><span class="p">(</span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Tax amounts do not match the expected values.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- 5. Validate Payment Terms</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">validate_payment_terms</span><span class="p">(</span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Payment terms do not match the customer’s default terms.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- 6. Retrieve and Validate Salesperson</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">salesperson_code</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">salesperson_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKAR_INV_SLSP</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARINV</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKAR_INV_NUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">salesperson_code</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Salesperson code not found for the invoice.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">validate_salesperson</span><span class="p">(</span><span class="o">@</span><span class="n">salesperson_code</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Salesperson is either inactive or does not exist.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- 7. Validate RMA</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">validate_rma</span><span class="p">(</span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="n">RAISERROR</span><span class="p">(</span><span class="s1">&#39;Approved RMA record not found for the invoice.&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Mark Point Logging (Functions 1-6)</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="c1">-- 1. Save Accounts Receivable and Customer Record (Markpoint 1 and 2)</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_1_and_2_SaveARAndCustomerRecord</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- 2. Save to Accounts Receivable and Check Account (Markpoint 3)</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_3_SaveToARAndCheckAccount</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- 3. Post to General Ledger (Markpoint 4)</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_4_PostToGL</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- 4. Post Freight to GL (Markpoint 5)</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_5_PostFreightToGL</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- 5. Post Fuel to GL (Markpoint 6)</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_6_PostFuelToGL</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Per Invoice Line Item Processing</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">lineCount</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- Get total number of lines in the invoice</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">lineCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKARINVL</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKAR_INV_NUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="n">WHILE</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">@</span><span class="n">lineCount</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="c1">-- 7. Update Inventory Location (Markpoint 7)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_7_UpdateInventoryLocation</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- 8. Save to Warehouse (Markpoint 8)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_8_SaveToWarehouse</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- 9. Update Inventory Master (Markpoint 9)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_9_UpdateInventoryMaster</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- 10. Post to Sales Account (Markpoint 10)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_10_PostToSalesAccount</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- 11. Post Restocking and Discounts (Markpoint 11)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="p">;</span>
<span class="w">            </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">discToPost</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Replace with actual discount retrieval logic</span>
<span class="w">            </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">restockAmt</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Replace with actual restocking amount retrieval logic</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_11_PostRestockingAndDiscounts</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">discToPost</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">restockAmt</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- 12. Post to Other Accounts (Markpoint 12)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_12_PostToOtherAccounts</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- 13. Post Warranty and Scrapped Items (Markpoint 13)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_13_PostWarrantyAndScrappedItems</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- 14. Save Inventory Transaction (Markpoint 14)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">14</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_14_SaveInventoryTransaction</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">logonCode</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- 15. Post Line Item Freight (Markpoint 15)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_15_PostLineItemFreight</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="p">;</span><span class="w"> </span>

<span class="w">            </span><span class="c1">-- 16. Archive Invoice Line Item (Markpoint 16)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_16_ArchiveInvoiceLineItem</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="p">;</span>

<span class="w">            </span><span class="c1">-- 17. Delete Invoice Line Item (Markpoint 17)</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">17</span><span class="p">;</span>
<span class="w">            </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">markpoint_17_DeleteInvoiceLineItem</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="p">;</span>

<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">currentLine</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>

<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Post-Invoice Level Processing</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="c1">-- 18. Update Points History (Markpoint 18)</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="p">;</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">points_earned</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Replace with actual points earned retrieval logic</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">points_class</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Replace with actual customer class retrieval logic</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">points_rate</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Replace with actual points rate retrieval logic</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">tot_ext</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Replace with actual total extended amount retrieval logic</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">lucky7</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Replace with actual lucky7 flag retrieval logic</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">Markpoint18_UpdatePointsHistory</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">points_cust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">customer_code</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">points_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">points_class</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">points_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">points_rate</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">points_earned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">points_earned</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">tot_ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">tot_ext</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">lucky7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">lucky7</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- 19. Update Customer Points (Markpoint 19)</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">19</span><span class="p">;</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">Markpoint19_UpdateCustomerPoints</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">invoice_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">points_earned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">points_earned</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">points_cust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">customer_code</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">lucky7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">lucky7</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- 20. Update Tax Authority (Markpoint 20)</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">Markpoint20_UpdateTaxAuthority</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- 21. Delete Invoice Sales Lines (Markpoint 23)</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">23</span><span class="p">;</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">Markpoint23_DeleteInvoiceSalesLines</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- 22. Process Invoice and Update Sales (Markpoint 24)</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">Markpoint24_ProcessInvoiceAndUpdateSales</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- 23. Transfer Invoice to Historical (Markpoint 25)</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span><span class="p">;</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">actualNL</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- Replace with actual number line retrieval logic</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">Markpoint25_TransferInvoiceToHistorical</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="o">@</span><span class="n">actualNL</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- 24. Delete or Update Invoice Header (Markpoint 26)</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">26</span><span class="p">;</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">Markpoint26_DeleteOrUpdateInvoiceHeader</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- =============================</span>
<span class="w">        </span><span class="c1">-- Finalization</span>
<span class="w">        </span><span class="c1">-- =============================</span>

<span class="w">        </span><span class="c1">-- Commit Transaction</span>
<span class="w">        </span><span class="k">COMMIT</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- Update post status</span>
<span class="w">        </span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">post_status</span><span class="p">;</span>

<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">TRY</span>
<span class="w">    </span><span class="k">BEGIN</span><span class="w"> </span><span class="n">CATCH</span>
<span class="w">        </span><span class="c1">-- Handle Errors</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@@</span><span class="n">TRANCOUNT</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="k">ROLLBACK</span><span class="w"> </span><span class="k">TRANSACTION</span><span class="p">;</span>

<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorMessage</span><span class="w"> </span><span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ERROR_MESSAGE</span><span class="p">();</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorSeverity</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ERROR_SEVERITY</span><span class="p">();</span>
<span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorState</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ERROR_STATE</span><span class="p">();</span>

<span class="w">        </span><span class="c1">-- Log the error to the ErrorLog table with InvoiceNumber and MarkPoint</span>
<span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">_PostingErrorLog</span><span class="w"> </span><span class="p">(</span><span class="n">InvoiceNumber</span><span class="p">,</span><span class="w"> </span><span class="n">MarkPoint</span><span class="p">,</span><span class="w"> </span><span class="n">ErrorMessage</span><span class="p">,</span><span class="w"> </span><span class="n">ErrorSeverity</span><span class="p">,</span><span class="w"> </span><span class="n">ErrorState</span><span class="p">)</span>
<span class="w">        </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">invoiceNum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">currentMarkPoint</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorMessage</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorSeverity</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorState</span><span class="p">);</span>

<span class="w">        </span><span class="c1">-- Re-raise the error to the calling environment</span>
<span class="w">        </span><span class="n">RAISERROR</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">ErrorMessage</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorSeverity</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ErrorState</span><span class="p">);</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">CATCH</span>

<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="k">GO</span>
</pre></div>
</div>
</section>
<section id="description">
<h2>Description<a class="headerlink" href="#description" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">post_so</span></code> stored procedure automates the processing of sales orders by:</p>
<ol class="arabic simple">
<li><p>Validating input parameters to ensure data integrity.</p></li>
<li><p>Managing database transactions with a <code class="docutils literal notranslate"><span class="pre">SERIALIZABLE</span></code> isolation level to prevent data anomalies.</p></li>
<li><p>Checking for idempotency to avoid duplicate processing of invoices.</p></li>
<li><p>Performing a series of pre-validation checks on invoice status, customer validity, inventory, tax calculations, payment terms, salesperson validity, and RMA records.</p></li>
<li><p>Logging mark points to track the progress of the processing steps.</p></li>
<li><p>Processing each line item in the invoice, including inventory updates, financial postings, and archival.</p></li>
<li><p>Performing post-invoice level operations such as updating points history, customer points, tax authority records, and transferring invoice data to historical tables.</p></li>
<li><p>Finalizing the transaction by committing changes and updating the post status.</p></li>
</ol>
<p>Comprehensive error handling ensures that any issues encountered during processing are logged appropriately, and transactions are rolled back to maintain data consistency.</p>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><strong>Database Environment:</strong> Microsoft SQL Server.</p></li>
<li><p><strong>Existing Tables:</strong> <code class="docutils literal notranslate"><span class="pre">BKSOMARK</span></code>, <code class="docutils literal notranslate"><span class="pre">BKARINV</span></code>, <code class="docutils literal notranslate"><span class="pre">BKARINVL</span></code>, <code class="docutils literal notranslate"><span class="pre">_PostingErrorLog</span></code>.</p></li>
<li><p><strong>Existing Stored Procedures/Functions:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">check_invoice_status</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_customer</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_inventory</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_tax</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_payment_terms</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_salesperson</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_rma</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_1_and_2_SaveARAndCustomerRecord</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_3_SaveToARAndCheckAccount</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_4_PostToGL</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_5_PostFreightToGL</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_6_PostFuelToGL</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_7_UpdateInventoryLocation</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_8_SaveToWarehouse</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_9_UpdateInventoryMaster</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_10_PostToSalesAccount</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_11_PostRestockingAndDiscounts</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_12_PostToOtherAccounts</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_13_PostWarrantyAndScrappedItems</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_14_SaveInventoryTransaction</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_15_PostLineItemFreight</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_16_ArchiveInvoiceLineItem</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_17_DeleteInvoiceLineItem</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint18_UpdatePointsHistory</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint19_UpdateCustomerPoints</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint20_UpdateTaxAuthority</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint23_DeleteInvoiceSalesLines</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint24_ProcessInvoiceAndUpdateSales</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint25_TransferInvoiceToHistorical</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint26_DeleteOrUpdateInvoiceHeader</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">post_status</span></code></p></li>
</ul>
</li>
</ul>
<p>Ensure all dependencies are created and tested prior to deploying the <code class="docutils literal notranslate"><span class="pre">post_so</span></code> stored procedure.</p>
</section>
<section id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Link to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Data Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&#64;invoiceNum</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">INT</span></code></p></td>
<td><p>The unique identifier for the sales invoice. Must be a positive integer.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&#64;logonCode</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">VARCHAR(20)</span></code></p></td>
<td><p>The logon code of the user initiating the procedure. Must not exceed 20 characters.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="procedure-steps">
<h2>Procedure Steps<a class="headerlink" href="#procedure-steps" title="Link to this heading">¶</a></h2>
<section id="parameter-validation">
<h3>1. Parameter Validation<a class="headerlink" href="#parameter-validation" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Invoice Number (<code class="docutils literal notranslate"><span class="pre">&#64;invoiceNum</span></code>):</strong> Ensures it is a positive integer.</p></li>
<li><p><strong>Logon Code (<code class="docutils literal notranslate"><span class="pre">&#64;logonCode</span></code>):</strong> Ensures it does not exceed 20 characters in length.</p></li>
</ul>
</section>
<section id="transaction-management">
<h3>2. Transaction Management<a class="headerlink" href="#transaction-management" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Sets the transaction isolation level to <code class="docutils literal notranslate"><span class="pre">SERIALIZABLE</span></code> to prevent concurrent transactions from interfering.</p></li>
<li><p>Begins a database transaction to ensure atomicity of the operations.</p></li>
</ul>
</section>
<section id="idempotency-check">
<h3>3. Idempotency Check<a class="headerlink" href="#idempotency-check" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Checks the <code class="docutils literal notranslate"><span class="pre">BKSOMARK</span></code> table to ensure the invoice has not already been processed (mark point 26 with <code class="docutils literal notranslate"><span class="pre">BKSOMARK_DONE</span> <span class="pre">=</span> <span class="pre">1</span></code>).</p></li>
<li><p>If already processed, raises an error and rolls back the transaction.</p></li>
</ul>
</section>
<section id="pre-validation-steps">
<h3>4. Pre-validation Steps<a class="headerlink" href="#pre-validation-steps" title="Link to this heading">¶</a></h3>
<p>Performs a series of validations to ensure the invoice is eligible for processing:</p>
<ol class="arabic simple">
<li><p><strong>Invoice Status:</strong> Validates using <code class="docutils literal notranslate"><span class="pre">check_invoice_status</span></code>.</p></li>
<li><p><strong>Customer Validation:</strong> Retrieves <code class="docutils literal notranslate"><span class="pre">&#64;customer_code</span></code> from <code class="docutils literal notranslate"><span class="pre">BKARINV</span></code> and validates using <code class="docutils literal notranslate"><span class="pre">validate_customer</span></code>.</p></li>
<li><p><strong>Inventory Validation:</strong> Ensures inventory items exist and have sufficient stock using <code class="docutils literal notranslate"><span class="pre">validate_inventory</span></code>.</p></li>
<li><p><strong>Tax Validation:</strong> Confirms tax amounts match expected values using <code class="docutils literal notranslate"><span class="pre">validate_tax</span></code>.</p></li>
<li><p><strong>Payment Terms Validation:</strong> Checks payment terms against customer defaults using <code class="docutils literal notranslate"><span class="pre">validate_payment_terms</span></code>.</p></li>
<li><p><strong>Salesperson Validation:</strong> Retrieves and validates <code class="docutils literal notranslate"><span class="pre">&#64;salesperson_code</span></code> using <code class="docutils literal notranslate"><span class="pre">validate_salesperson</span></code>.</p></li>
<li><p><strong>RMA Validation:</strong> Ensures an approved RMA record exists using <code class="docutils literal notranslate"><span class="pre">validate_rma</span></code>.</p></li>
</ol>
<p>Each failed validation raises an error and rolls back the transaction.</p>
</section>
<section id="mark-point-header-routines">
<h3>5. Mark Point Header Routines<a class="headerlink" href="#mark-point-header-routines" title="Link to this heading">¶</a></h3>
<p>Logs progress at various stages (mark points 1-6) by executing corresponding stored procedures:</p>
<ol class="arabic simple">
<li><p><strong>Markpoint 1 &amp; 2:</strong> Save Accounts Receivable and Customer Record.</p></li>
<li><p><strong>Markpoint 3:</strong> Save to Accounts Receivable and Check Account.</p></li>
<li><p><strong>Markpoint 4:</strong> Post to General Ledger.</p></li>
<li><p><strong>Markpoint 5:</strong> Post Freight to GL.</p></li>
<li><p><strong>Markpoint 6:</strong> Post Fuel to GL.</p></li>
</ol>
</section>
<section id="mark-point-per-invoice-line-item-processing">
<h3>6. Mark point Per Invoice Line Item Processing<a class="headerlink" href="#mark-point-per-invoice-line-item-processing" title="Link to this heading">¶</a></h3>
<p>Processes each line item in the invoice sequentially:</p>
<ol class="arabic simple">
<li><p><strong>Markpoint 7:</strong> Update Inventory Location.</p></li>
<li><p><strong>Markpoint 8:</strong> Save to Warehouse.</p></li>
<li><p><strong>Markpoint 9:</strong> Update Inventory Master.</p></li>
<li><p><strong>Markpoint 10:</strong> Post to Sales Account.</p></li>
<li><p><strong>Markpoint 11:</strong> Post Restocking and Discounts.</p></li>
<li><p><strong>Markpoint 12:</strong> Post to Other Accounts.</p></li>
<li><p><strong>Markpoint 13:</strong> Post Warranty and Scrapped Items.</p></li>
<li><p><strong>Markpoint 14:</strong> Save Inventory Transaction.</p></li>
<li><p><strong>Markpoint 15:</strong> Post Line Item Freight.</p></li>
<li><p><strong>Markpoint 16:</strong> Archive Invoice Line Item.</p></li>
<li><p><strong>Markpoint 17:</strong> Delete Invoice Line Item.</p></li>
</ol>
<p>Each mark point execution updates the <code class="docutils literal notranslate"><span class="pre">&#64;currentMarkPoint</span></code> variable to facilitate error logging.</p>
</section>
<section id="mark-point-post-invoice-level-processing">
<h3>7. Mark point Post-Invoice Level Processing<a class="headerlink" href="#mark-point-post-invoice-level-processing" title="Link to this heading">¶</a></h3>
<p>Performs operations after all line items have been processed:</p>
<ol class="arabic simple">
<li><p><strong>Markpoint 18:</strong> Update Points History.</p></li>
<li><p><strong>Markpoint 19:</strong> Update Customer Points.</p></li>
<li><p><strong>Markpoint 20:</strong> Update Tax Authority.</p></li>
<li><p><strong>Markpoint 23:</strong> Delete Invoice Sales Lines.</p></li>
<li><p><strong>Markpoint 24:</strong> Process Invoice and Update Sales.</p></li>
<li><p><strong>Markpoint 25:</strong> Transfer Invoice to Historical.</p></li>
<li><p><strong>Markpoint 26:</strong> Delete or Update Invoice Header.</p></li>
</ol>
</section>
<section id="finalization">
<h3>8. Finalization<a class="headerlink" href="#finalization" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Commits the transaction to persist all changes.</p></li>
<li><p>Executes <code class="docutils literal notranslate"><span class="pre">post_status</span></code> to update the post status accordingly.</p></li>
</ul>
</section>
</section>
<section id="error-handling">
<h2>Error Handling<a class="headerlink" href="#error-handling" title="Link to this heading">¶</a></h2>
<p>The procedure employs robust error handling mechanisms:</p>
<ul class="simple">
<li><p><strong>TRY…CATCH Block:</strong> Encapsulates the main processing logic within a <code class="docutils literal notranslate"><span class="pre">BEGIN</span> <span class="pre">TRY</span></code> block and catches any exceptions in the <code class="docutils literal notranslate"><span class="pre">BEGIN</span> <span class="pre">CATCH</span></code> block.</p></li>
<li><p><strong>Transaction Rollback:</strong> If an error occurs and a transaction is active, it is rolled back to maintain data integrity.</p></li>
<li><p><strong>Error Logging:</strong> Errors are logged into the <code class="docutils literal notranslate"><span class="pre">dbo._PostingErrorLog</span></code> table with details including <code class="docutils literal notranslate"><span class="pre">InvoiceNumber</span></code>, <code class="docutils literal notranslate"><span class="pre">MarkPoint</span></code>, <code class="docutils literal notranslate"><span class="pre">ErrorMessage</span></code>, <code class="docutils literal notranslate"><span class="pre">ErrorSeverity</span></code>, and <code class="docutils literal notranslate"><span class="pre">ErrorState</span></code>.</p></li>
<li><p><strong>Error Propagation:</strong> After logging, the error is re-raised to notify the calling environment of the failure.</p></li>
</ul>
</section>
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">post_so</span></code> stored procedure relies on several other stored procedures and functions. Ensure the following dependencies are in place before deploying <code class="docutils literal notranslate"><span class="pre">post_so</span></code>:</p>
<ul class="simple">
<li><p><strong>Validation Functions:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">check_invoice_status</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_customer</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_inventory</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_tax</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_payment_terms</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_salesperson</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_rma</span></code></p></li>
</ul>
</li>
<li><p><strong>Mark Point Procedures:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_1_and_2_SaveARAndCustomerRecord</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_3_SaveToARAndCheckAccount</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_4_PostToGL</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_5_PostFreightToGL</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_6_PostFuelToGL</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_7_UpdateInventoryLocation</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_8_SaveToWarehouse</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_9_UpdateInventoryMaster</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_10_PostToSalesAccount</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_11_PostRestockingAndDiscounts</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_12_PostToOtherAccounts</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_13_PostWarrantyAndScrappedItems</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_14_SaveInventoryTransaction</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_15_PostLineItemFreight</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_16_ArchiveInvoiceLineItem</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markpoint_17_DeleteInvoiceLineItem</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint18_UpdatePointsHistory</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint19_UpdateCustomerPoints</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint20_UpdateTaxAuthority</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint23_DeleteInvoiceSalesLines</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint24_ProcessInvoiceAndUpdateSales</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint25_TransferInvoiceToHistorical</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Markpoint26_DeleteOrUpdateInvoiceHeader</span></code></p></li>
</ul>
</li>
<li><p><strong>Error Logging Table:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">dbo._PostingErrorLog</span></code></p></li>
</ul>
</li>
<li><p><strong>Status Procedure:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">post_status</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="example-usage">
<h2>Example Usage<a class="headerlink" href="#example-usage" title="Link to this heading">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">post_so</span><span class="w"> </span><span class="o">@</span><span class="n">invoiceNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12345</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">logonCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;USER123&#39;</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>

</main>
                        <nav aria-label="Page navigation" class="py-4 my-5 clearfix font-weight-bold border-top">
    <a class="float-left" href="index.html" title="Previous">
        <span aria-hidden="true">←&nbsp;</span>TAS Posting documentation
    </a>
    <a class="float-right" href="pre-valiation.html" title="Next">
        Pre-validation SQL Procedures <span aria-hidden="true">&nbsp;→</span>
    </a>
</nav>
                    </div>
                    
                    <nav class="col-12 col-lg-3 pb-4">
                        <div class="sticky-top toc page-toc" aria-labelledby="page-toc-heading">
                            <p class="font-weight-bold" id="page-toc-heading">Page contents</p>
                            <ul>
<li><a class="reference internal" href="#"><code class="docutils literal notranslate"><span class="pre">post_so</span></code> Stored Procedure Documentation</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#table-of-contents">Table of Contents</a></li>
<li><a class="reference internal" href="#sql-code">SQL Code</a></li>
<li><a class="reference internal" href="#description">Description</a></li>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#parameters">Parameters</a></li>
<li><a class="reference internal" href="#procedure-steps">Procedure Steps</a><ul>
<li><a class="reference internal" href="#parameter-validation">1. Parameter Validation</a></li>
<li><a class="reference internal" href="#transaction-management">2. Transaction Management</a></li>
<li><a class="reference internal" href="#idempotency-check">3. Idempotency Check</a></li>
<li><a class="reference internal" href="#pre-validation-steps">4. Pre-validation Steps</a></li>
<li><a class="reference internal" href="#mark-point-header-routines">5. Mark Point Header Routines</a></li>
<li><a class="reference internal" href="#mark-point-per-invoice-line-item-processing">6. Mark point Per Invoice Line Item Processing</a></li>
<li><a class="reference internal" href="#mark-point-post-invoice-level-processing">7. Mark point Post-Invoice Level Processing</a></li>
<li><a class="reference internal" href="#finalization">8. Finalization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#error-handling">Error Handling</a></li>
<li><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li><a class="reference internal" href="#example-usage">Example Usage</a></li>
</ul>
</li>
</ul>

                        </div>
                    </nav>
                    
                </div>
            </div>
        </div>
    </div>
    <footer class="container-fluid bg-primary text-light">
        <div class="container">
            <div class="row">
        <div class="col p-4">
            
                <nav aria-label="Footer">
                    <ul class="nav justify-content-center mb-2">
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/features/">Features</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/about-wagtail/"> About Wagtail</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/services/"> Services</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/blog/"> Blog</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/packages/"> Packages</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/developers/"> Developers</a></li>
                        
                    </ul>
                </nav>
            
            <div class="text-center">
                <p style="display: none">
                    <a class="text-light" href="https://github.com/wagtail/sphinx_wagtail_theme" rel="nofollow" target="_blank">
                        Wagtail Sphinx Theme 6.3.0
                    </a>
                </p>
            </div>
            <div class="text-center">
                    &copy; Copyright 2024, Chris Watkins
            </div>
        </div>
    </div>
        </div>
    </footer>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script type="text/javascript" src="_static/dist/theme.js"></script>
        <script type="text/javascript" src="_static/dist/vendor.js"></script>
        <script type="text/javascript" src="_static/searchtools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() { Search.loadIndex("searchindex.js"); });
        </script>
        <script type="text/javascript" id="searchindexloader"></script>
    </body>
</html>