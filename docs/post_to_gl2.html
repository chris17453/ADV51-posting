<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
        <title>post_to_gl2: Post to General Ledger &mdash; TAS Posting  documentation</title>
    
    <link rel="stylesheet" type="text/css" href="_static/dist/fontawesome.css" />
      <link rel="stylesheet" type="text/css" href="_static/dist/theme.css?v=ea6a6c20" />
            <link rel="index" title="Index" href="genindex.html" />
            <link rel="search" title="Search" href="search.html" />
            <link rel="top" title="TAS Posting  documentation" href="#" />
            <link rel="next" title="All tables" href="all_tables.html" />
            <link rel="prev" title="Create invoice from history" href="create_invoice_from_history.html" />
    </head>
<body>
    <script type="text/javascript" src="_static/dist/blocking.js"></script>
    <header class="container-fluid bg-primary">
        <a class="btn btn-sm btn-light skip-to-content-link" href="#main">Skip to content</a>
        <div class="container-fluid">
            <div class="navbar navbar-expand-lg navbar-dark font-weight-bold">
                    <a href="index.html"
                        title="Wagtail"
                        class="logo navbar-brand"
                    >
                        <img src="_static/img/wagtail-logo-new.svg" width="45" height="59" alt="Wagtail"
                            class="logo-img"
                        />
                        ADV 5.1 Posting Migration
                    </a>
                
                
                <button class="navbar-toggler btn btn-primary d-lg-none" type="button" data-toggle="collapse" data-target="#collapseSidebar" aria-expanded="false" aria-controls="collapseExample">
                    <span class="navbar-toggler-icon"></span>
                    <span class="sr-only">menu</span>
                </button>
            </div>
        </div>
    </header>
    <div class="container-fluid">
        <div class="row">
            <aside class="col-12 col-lg-3 sidebar-container">
                <div id="collapseSidebar" class="collapse sticky-top d-lg-block pt-5 pr-lg-4">
<div id="searchbox" class="searchbox mb-6 px-1" role="search">
    <form id="search-form" action="search.html" autocomplete="off" method="get" role="search">
        <div class="input-group">
            <div class="input-group-prepend">
                <div class="input-group-text border-right-0 bg-white py-3 pl-3 pr-2"><span class="fas fa-search"></span></div>
            </div>
            <input class="form-control py-3 pr-3 pl-1 h-100 border-left-0" type="search" name="q" placeholder="Search documentation" aria-label="Search documentation" id="searchinput" />
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div><div class="site-toc">
    <nav class="toc mt-3" aria-label="Main menu">
        <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="post_so.html"><code class="docutils literal notranslate"><span class="pre">post_so</span></code> Stored Procedure Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="post_so.html#helper-functions">Helper functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="pre-valiation.html">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-1.html">Mark Point 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-3.html">Mark Point 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-4.html">Mark Point 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-5.html">Mark Point 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-6.html">Mark Point 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-7.html">Mark Point 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-8.html">Mark Point 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-9.html">Mark Point 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-10.html">Mark Point 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-11.html">Mark Point 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-12.html">Mark Point 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-13.html">Mark Point 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-14.html">Mark Point 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-15.html">Mark Point 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-16.html">Mark Point 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-17.html">Mark Point 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-18.html">Mark Point 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-19.html">Mark Point 19</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-20.html">Mark Point 20</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-23.html">Mark Point 23</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-24.html">Mark Point 24</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-25.html">Mark Point 25</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint-26.html">Mark Point 26</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_invoice_from_history.html">create_invoice_from_history</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">post_to_gl2</a></li>
<li class="toctree-l1"><a class="reference internal" href="all_tables.html">All Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="markpoint.html">Markpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="errorlog.html">ErrorLog</a></li>
</ul>

    </nav>
    <template data-toggle-item-template>
        <button class="btn btn-sm btn-link toctree-expand" type="button">
            <span class="sr-only">Toggle menu contents</span>
        </button>
    </template>
</div>
                    <div class="d-lg-none border-bottom">
                        
                    </div>
                </div>
            </aside>
            <div class="col-12 col-lg-9 pt-5">
                <header class="row align-items-baseline">
                    <div class="col">
                        <nav aria-label="breadcrumb">
    <ol class="breadcrumb m-0 p-0 bg-transparent">
        <li class="breadcrumb-item"><a href="index.html">Docs</a></li>
        <li class="breadcrumb-item active" aria-current="page">post_to_gl2: Post to General Ledger</li>
    </ol>
</nav>
                    </div>
                    <div class="col-sm-12 col-lg-auto mt-3 mt-lg-3">
                        <noscript>
                            <p>JavaScript is required to toggle light/dark mode..</p>
                        </noscript>
                        <button id="wagtail-theme" class="btn btn-sm btn-light text-decoration-none" type="button">
                            <span class="dark-only"><i class="fas fa-sun"></i> Light mode</span>
                            <span class="light-only"><i class="fas fa-moon"></i> Dark mode</span>
                        </button>
    <a class="btn btn-sm btn-light text-decoration-none" href="https://github.com/wagtail/sphinx_wagtail_theme/blob/main/docs/post_to_gl2.md" rel="nofollow">
        <span class="btn-icon"><span class="fab fa-github"></span></span>
        <span class="btn-text">Edit on GitHub</span>
    </a>
    <a class="btn btn-sm btn-light text-decoration-none" href="_sources/post_to_gl2.md.txt" rel="nofollow">
        <span class="btn-icon"><span class="fas fa-code"></span></span>
        <span class="btn-text">View source</span>
    </a>
                        
                    </div>
                </header>
                <div class="row" >
                    <div class="col-12">
                        <hr class="w-100 my-4">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-lg-9 order-last order-lg-first rst-content">
                        <main role="main" id="main">
    <section id="post-to-gl2-post-to-general-ledger">
<h1>post_to_gl2: Post to General Ledger<a class="headerlink" href="#post-to-gl2-post-to-general-ledger" title="Link to this heading">¶</a></h1>
<section id="summary">
<h2>Summary:<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>This function posts financial data to the general ledger (GL) based on the provided account, department, description, amount, and other details. It checks if the GL account exists, falls back to a clearing account if needed, manages cash transaction logic, and updates the general ledger records.</p>
</section>
<section id="mssql-procedure">
<h2>MSSQL Procedure<a class="headerlink" href="#mssql-procedure" title="Link to this heading">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">PostToGL2</span>
<span class="w">    </span><span class="o">@</span><span class="n">post_acct</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
<span class="w">    </span><span class="o">@</span><span class="n">post_dpt</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
<span class="w">    </span><span class="o">@</span><span class="n">post_desc</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="o">@</span><span class="n">post_amt</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span>
<span class="w">    </span><span class="o">@</span><span class="n">post_invnum</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
<span class="w">    </span><span class="o">@</span><span class="n">post_date</span><span class="w"> </span><span class="nb">DATE</span><span class="p">,</span>
<span class="w">    </span><span class="o">@</span><span class="n">post_tran_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
<span class="w">    </span><span class="o">@</span><span class="n">post_code</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
<span class="w">    </span><span class="o">@</span><span class="n">post_chk_cash</span><span class="w"> </span><span class="nb">BIT</span><span class="p">,</span>
<span class="w">    </span><span class="o">@</span><span class="n">post_quit</span><span class="w"> </span><span class="nb">BIT</span><span class="w"> </span><span class="k">OUT</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="c1">-- Declare variables</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">post_mnth</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_GLDPT</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">post_other</span><span class="w"> </span><span class="nb">BIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">post_fail</span><span class="w"> </span><span class="nb">BIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">post_amt_abs</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_TRN_DC</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">post_quit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- If post amount is zero, exit early</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">post_amt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">RETURN</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Calculate posting month</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">post_mnth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">MONTH</span><span class="p">(</span><span class="o">@</span><span class="n">post_date</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Initialize GL account and department</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">post_acct</span><span class="p">;</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_GLDPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">post_dpt</span><span class="p">;</span>

<span class="w">    </span><span class="c1">-- Check if the GL account exists (BKGLCOA table)</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKGLCOA</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">post_acct</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">BKGL_GLDPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">post_dpt</span><span class="p">)</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="c1">-- Use the clearing account if the original account is not found</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">post_other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKSY_GL_CLRING</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_GLDPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKSY_GLDPT_CLR</span><span class="p">;</span>

<span class="w">        </span><span class="c1">-- Check if clearing account exists</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKGLCOA</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">BKGL_GLDPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_GLDPT</span><span class="p">)</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="c1">-- Fail if neither the original nor the clearing account is found</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">post_fail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">post_quit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">RETURN</span><span class="p">;</span>
<span class="w">        </span><span class="k">END</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="c1">-- Set transaction direction (debit/credit) based on the amount</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_TRN_DC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">post_amt</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_TRN_DC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;C&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="c1">-- Post transaction details into BKGLTRAN table</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">BKGLTRAN</span><span class="w"> </span><span class="p">(</span><span class="n">BKGL_TRN_TYPE</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_TRN_DATE</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_TRN_INVC</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_TRN_DESC</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_TRN_GLACCT</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_TRN_GLDPT</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_TRN_CODE</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_TRN_DC</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_TRN_AMT</span><span class="p">)</span>
<span class="w">    </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">post_tran_type</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">post_date</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">post_invnum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">post_desc</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_ACCT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_GLDPT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">post_code</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_TRN_DC</span><span class="p">,</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="o">@</span><span class="n">post_amt</span><span class="p">));</span>

<span class="w">    </span><span class="c1">-- Handle cash transaction if required</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">post_chk_cash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="c1">-- Check if the cash account exists in BKSYCHCK table</span>
<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKSYCHCK</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKSY_CHCK_ACT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">BKSY_CHCK_GLDPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_GLDPT</span><span class="p">)</span>
<span class="w">        </span><span class="k">BEGIN</span>
<span class="w">            </span><span class="c1">-- Insert cash transaction details into BKGLCHK table</span>
<span class="w">            </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">BKGLCHK</span><span class="w"> </span><span class="p">(</span><span class="n">BKGL_CHK_ACTNM</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_CHK_DATE</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_CHK_TYPE</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_CHK_AMT</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_CHK_NUM</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_CHK_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">BKGL_CHK_FLAG</span><span class="p">)</span>
<span class="w">            </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">BKGL_ACCT</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">post_date</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="o">@</span><span class="n">post_amt</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;C&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="w"> </span><span class="k">END</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="k">ABS</span><span class="p">(</span><span class="o">@</span><span class="n">post_amt</span><span class="p">),</span><span class="w"> </span><span class="o">@</span><span class="n">post_invnum</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">post_desc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="k">END</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="c1">-- Update BKGLCOA balances based on the posting month and year</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">YEAR</span><span class="p">(</span><span class="o">@</span><span class="n">post_date</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">YEAR</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">())</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">BKGLCOA</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">BKGL_CURRENT</span><span class="p">[</span><span class="o">@</span><span class="n">post_mnth</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKGL_CURRENT</span><span class="p">[</span><span class="o">@</span><span class="n">post_mnth</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">post_amt</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">BKGL_GLDPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_GLDPT</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">BKGLCOA</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">BKGL_1YPAST</span><span class="p">[</span><span class="o">@</span><span class="n">post_mnth</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BKGL_1YPAST</span><span class="p">[</span><span class="o">@</span><span class="n">post_mnth</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">post_amt</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">BKGL_GLDPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_GLDPT</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="c1">-- Recalculate total balance (sum of months)</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">current_total</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">i</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="o">@</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">13</span>
<span class="w">    </span><span class="k">BEGIN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">current_total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">current_total</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">BKGL_CURRENT</span><span class="p">[</span><span class="o">@</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">BKGLCOA</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">BKGL_GLDPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_GLDPT</span><span class="p">);</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span>

<span class="w">    </span><span class="c1">-- Update the total balance for the account</span>
<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">BKGLCOA</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">BKGL_CURRENT</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">current_total</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_ACCT</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">BKGL_GLDPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">BKGL_GLDPT</span><span class="p">;</span>

<span class="k">END</span>
<span class="k">GO</span>
</pre></div>
</div>
<section id="breakdown-of-tasks">
<h3>Breakdown of Tasks:<a class="headerlink" href="#breakdown-of-tasks" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Check for Zero Amount:</strong></p>
<ul class="simple">
<li><p>The function exits early if <code class="docutils literal notranslate"><span class="pre">&#64;post_amt</span> <span class="pre">=</span> <span class="pre">0</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Calculate Posting Month:</strong></p>
<ul class="simple">
<li><p>Adds 1 to the month extracted from <code class="docutils literal notranslate"><span class="pre">&#64;post_date</span></code> to determine the posting month.</p></li>
</ul>
</li>
<li><p><strong>Validate GL Account:</strong></p>
<ul class="simple">
<li><p>Checks if the GL account and department exist in the <code class="docutils literal notranslate"><span class="pre">BKGLCOA</span></code> table. If not found, it falls back to a clearing account (<code class="docutils literal notranslate"><span class="pre">BKSY_GL_CLRING</span></code>).</p></li>
<li><p>If neither the original nor clearing account is found, the function sets <code class="docutils literal notranslate"><span class="pre">&#64;post_quit</span> <span class="pre">=</span> <span class="pre">1</span></code> and returns early.</p></li>
</ul>
</li>
<li><p><strong>Set Debit or Credit Based on Amount:</strong></p>
<ul class="simple">
<li><p>The function sets the transaction as a debit (<code class="docutils literal notranslate"><span class="pre">D</span></code>) or credit (<code class="docutils literal notranslate"><span class="pre">C</span></code>) depending on whether the amount is positive or negative.</p></li>
</ul>
</li>
<li><p><strong>Insert Transaction into GL Table:</strong></p>
<ul class="simple">
<li><p>Inserts the transaction details into the <code class="docutils literal notranslate"><span class="pre">BKGLTRAN</span></code> table, with values for account, department, description, transaction type, code, and the debit/credit flag.</p></li>
</ul>
</li>
<li><p><strong>Cash Transaction Handling:</strong></p>
<ul class="simple">
<li><p>If the transaction is a cash transaction (<code class="docutils literal notranslate"><span class="pre">&#64;post_chk_cash</span> <span class="pre">=</span> <span class="pre">1</span></code>), it checks the <code class="docutils literal notranslate"><span class="pre">BKSYCHCK</span></code> table for a cash account.</p></li>
<li><p>If found, the function inserts a record into the <code class="docutils literal notranslate"><span class="pre">BKGLCHK</span></code> table with the cash details.</p></li>
</ul>
</li>
<li><p><strong>Update GL Account Balances:</strong></p>
<ul class="simple">
<li><p>Depending on whether the transaction occurred in the current year or a past year, it updates either <code class="docutils literal notranslate"><span class="pre">BKGL_CURRENT</span></code> or <code class="docutils literal notranslate"><span class="pre">BKGL_1YPAST</span></code> fields for the specific posting month.</p></li>
</ul>
</li>
<li><p><strong>Recalculate Total Balances:</strong></p>
<ul class="simple">
<li><p>Recalculates the total balance by summing the balances from months 1 to 13, and then updates the total balance (<code class="docutils literal notranslate"><span class="pre">BKGL_CURRENT[14]</span></code>) for the account.</p></li>
</ul>
</li>
</ol>
</section>
<section id="error-handling">
<h3>Error Handling:<a class="headerlink" href="#error-handling" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Proper error handling should be included with <code class="docutils literal notranslate"><span class="pre">TRY...CATCH</span></code> blocks to ensure that any errors during the <code class="docutils literal notranslate"><span class="pre">INSERT</span></code>, <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code>, or validation processes are managed.</p></li>
<li><p>If the GL account cannot be found (original or clearing), the function gracefully exits by setting <code class="docutils literal notranslate"><span class="pre">&#64;post_quit</span> <span class="pre">=</span> <span class="pre">1</span></code>.</p></li>
</ul>
</section>
<section id="testing">
<h3>Testing:<a class="headerlink" href="#testing" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Test Case 1: Valid Posting</strong></p>
<ul>
<li><p>Run the function with valid data (account, department, amount) and verify that the general ledger transaction is recorded correctly.</p></li>
</ul>
</li>
<li><p><strong>Test Case 2: Missing Account</strong></p>
<ul>
<li><p>Run the function with a missing or invalid account and confirm that it falls back to the clearing account or exits if neither account is found.</p></li>
</ul>
</li>
<li><p><strong>Test Case 3: Cash Transaction</strong></p>
<ul>
<li><p>Run the function with <code class="docutils literal notranslate"><span class="pre">&#64;post_chk_cash</span> <span class="pre">=</span> <span class="pre">1</span></code> and verify that a record is correctly inserted into the <code class="docutils literal notranslate"><span class="pre">BKGLCHK</span></code> table for a cash transaction.</p></li>
</ul>
</li>
<li><p><strong>Test Case 4: Error Handling</strong></p>
<ul>
<li><p>Simulate database constraints or other errors to ensure that the function gracefully handles failures without leaving incomplete transactions.</p></li>
</ul>
</li>
</ul>
</section>
<section id="notes">
<h3>Notes:<a class="headerlink" href="#notes" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Locking and Concurrency</strong>: The function assumes appropriate row-level locking during the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>, <code class="docutils literal notranslate"><span class="pre">INSERT</span></code>, and <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> operations to ensure data integrity.</p></li>
<li><p><strong>Performance Considerations</strong>: The recalculation of total balances is done by summing each month’s balance, which could impact performance on larger datasets. If performance becomes an issue, consider indexing and optimizing the queries.</p></li>
</ul>
</section>
</section>
</section>

</main>
                        <nav aria-label="Page navigation" class="py-4 my-5 clearfix font-weight-bold border-top">
    <a class="float-left" href="create_invoice_from_history.html" title="Previous">
        <span aria-hidden="true">←&nbsp;</span>Create invoice from history
    </a>
    <a class="float-right" href="all_tables.html" title="Next">
        All tables <span aria-hidden="true">&nbsp;→</span>
    </a>
</nav>
                    </div>
                    
                    <nav class="col-12 col-lg-3 pb-4">
                        <div class="sticky-top toc page-toc" aria-labelledby="page-toc-heading">
                            <p class="font-weight-bold" id="page-toc-heading">Page contents</p>
                            <ul>
<li><a class="reference internal" href="#">post_to_gl2: Post to General Ledger</a><ul>
<li><a class="reference internal" href="#summary">Summary:</a></li>
<li><a class="reference internal" href="#mssql-procedure">MSSQL Procedure</a><ul>
<li><a class="reference internal" href="#breakdown-of-tasks">Breakdown of Tasks:</a></li>
<li><a class="reference internal" href="#error-handling">Error Handling:</a></li>
<li><a class="reference internal" href="#testing">Testing:</a></li>
<li><a class="reference internal" href="#notes">Notes:</a></li>
</ul>
</li>
</ul>
</li>
</ul>

                        </div>
                    </nav>
                    
                </div>
            </div>
        </div>
    </div>
    <footer class="container-fluid bg-primary text-light">
        <div class="container">
            <div class="row">
        <div class="col p-4">
            
                <nav aria-label="Footer">
                    <ul class="nav justify-content-center mb-2">
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/features/">Features</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/about-wagtail/"> About Wagtail</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/services/"> Services</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/blog/"> Blog</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/packages/"> Packages</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/developers/"> Developers</a></li>
                        
                    </ul>
                </nav>
            
            <div class="text-center">
                <p style="display: none">
                    <a class="text-light" href="https://github.com/wagtail/sphinx_wagtail_theme" rel="nofollow" target="_blank">
                        Wagtail Sphinx Theme 6.3.0
                    </a>
                </p>
            </div>
            <div class="text-center">
                    &copy; Copyright 2024, Chris Watkins
            </div>
        </div>
    </div>
        </div>
    </footer>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script type="text/javascript" src="_static/dist/theme.js"></script>
        <script type="text/javascript" src="_static/dist/vendor.js"></script>
        <script type="text/javascript" src="_static/searchtools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() { Search.loadIndex("searchindex.js"); });
        </script>
        <script type="text/javascript" id="searchindexloader"></script>
    </body>
</html>